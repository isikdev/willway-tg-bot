{% extends 'admin/base.html' %}

{% block title %}WillWay Админ-панель - Блогеры{% endblock %}

{% block page_title %}Блогеры{% endblock %}

{% block content %}
<div class="mt-8">
    <div class="md:flex md:items-center md:justify-between">
        <div class="min-w-0 flex-1">
            <h2
                class="text-lg font-medium leading-7 text-gray-900 sm:truncate sm:text-xl sm:tracking-tight">
                Управление блогерами-рефералами
            </h2>
            <p class="mt-1 text-sm text-gray-500">
                В этом разделе вы можете управлять блогерами, участвующими в
                реферальной программе (20% с каждой покупки).
            </p>
        </div>
        <div class="mt-4 flex md:ml-4 md:mt-0">
            <button id="add-blogger-btn" type="button"
                class="ml-3 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                <svg class="-ml-1 mr-2 h-5 w-5" viewBox="0 0 20 20"
                    fill="currentColor" aria-hidden="true">
                    <path
                        d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Добавить блогера
            </button>
        </div>
    </div>

    <!-- Статистика по блогерам -->
    <div class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-3">
        <div class="overflow-hidden rounded-lg bg-white shadow">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-gray-400" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt
                                class="text-sm font-medium text-gray-500 truncate">Всего
                                блогеров</dt>
                            <dd class="text-lg font-medium text-gray-900"
                                id="stats-total-bloggers">—</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="overflow-hidden rounded-lg bg-white shadow">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-gray-400" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25V4.5m5.834.166l-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243l-1.59-1.59" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt
                                class="text-sm font-medium text-gray-500 truncate">Всего
                                переходов</dt>
                            <dd class="text-lg font-medium text-gray-900"
                                id="stats-total-referrals">—</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="overflow-hidden rounded-lg bg-white shadow">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-gray-400" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt
                                class="text-sm font-medium text-gray-500 truncate">Всего
                                заработано</dt>
                            <dd class="text-lg font-medium text-gray-900"
                                id="stats-total-earned">—</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблица блогеров -->
    <div
        class="mt-6 overflow-hidden rounded-lg border border-gray-200 bg-white shadow">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th scope="col"
                            class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Имя
                        </th>
                        <th scope="col"
                            class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Ключ доступа
                        </th>
                        <th scope="col"
                            class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Дата регистрации
                        </th>
                        <th scope="col"
                            class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Рефералы
                        </th>
                        <th scope="col"
                            class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Конверсии
                        </th>
                        <th scope="col"
                            class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Заработок
                        </th>
                        <th scope="col"
                            class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Статус
                        </th>
                        <th scope="col"
                            class="px-6 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Действия
                        </th>
                    </tr>
                </thead>
                <tbody id="bloggers-list"
                    class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="8"
                            class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                            Загрузка данных...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Модальное окно добавления блогера -->
<div id="add-blogger-modal" class="fixed z-10 inset-0 overflow-y-auto hidden"
    aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div
        class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
            aria-hidden="true"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen"
            aria-hidden="true">&#8203;</span>

        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900"
                            id="modal-title">
                            Добавить нового блогера
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                Заполните информацию о блогере. После добавления
                                блогера будет сгенерирован уникальный ключ
                                доступа.
                            </p>
                        </div>

                        <div class="mt-4 space-y-4">
                            <div>
                                <label for="blogger-name"
                                    class="block text-sm font-medium text-gray-700">Имя/никнейм</label>
                                <input type="text" name="blogger-name"
                                    id="blogger-name"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                            </div>

                            <div>
                                <label for="blogger-email"
                                    class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" name="blogger-email"
                                    id="blogger-email"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                            </div>

                            <div>
                                <label for="blogger-telegram"
                                    class="block text-sm font-medium text-gray-700">Username</label>
                                <input type="text" name="blogger-telegram"
                                    id="blogger-telegram"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                                    placeholder="Имя пользователя в Telegram без @">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div
                class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="save-blogger"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm">
                    Добавить
                </button>
                <button type="button" id="cancel-add-blogger"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Отмена
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadBloggers();
        loadStats();
        
        // Обработчики для модального окна добавления блогера
        document.getElementById('add-blogger-btn').addEventListener('click', function() {
            document.getElementById('add-blogger-modal').classList.remove('hidden');
        });
        
        document.getElementById('cancel-add-blogger').addEventListener('click', function() {
            document.getElementById('add-blogger-modal').classList.add('hidden');
        });
        
        document.getElementById('save-blogger').addEventListener('click', function() {
            addBlogger();
        });
    });
    
    function loadStats() {
        fetch('/api/bloggers/stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('stats-total-bloggers').textContent = data.stats.total_bloggers;
                    document.getElementById('stats-total-referrals').textContent = data.stats.total_referrals;
                    document.getElementById('stats-total-earned').textContent = data.stats.total_earnings + ' ₽';
                }
            })
            .catch(error => console.error('Ошибка при загрузке статистики:', error));
    }
    
    function loadBloggers() {
        fetch('/api/bloggers')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderBloggers(data.bloggers);
                }
            })
            .catch(error => console.error('Ошибка при загрузке блогеров:', error));
    }
    
    function renderBloggers(bloggers) {
        const bloggersListElement = document.getElementById('bloggers-list');
        
        if (bloggers.length === 0) {
            bloggersListElement.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        Нет добавленных блогеров
                    </td>
                </tr>
            `;
            return;
        }
        
        bloggersListElement.innerHTML = '';
        
        bloggers.forEach(blogger => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${blogger.name}</div>
                            <div class="text-sm text-gray-500">${blogger.email || '-'}</div>
                            <div class="text-sm text-gray-500">${blogger.telegram_id ? '@' + blogger.telegram_id : '-'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${blogger.access_key}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${blogger.created_at || '-'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${blogger.referrals_count || 0}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${blogger.converted_count || 0}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-primary">
                    ${blogger.earnings || 0} ₽
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${blogger.is_active ? 
                        '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Активен</span>' : 
                        '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Неактивен</span>'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a href="/admin/bloggers/${blogger.id}" class="text-primary hover:text-primary-dark">Статистика</a>
                    <button data-id="${blogger.id}" class="ml-3 text-red-600 hover:text-red-900 delete-blogger-btn">Удалить</button>
                </td>
            `;
            
            bloggersListElement.appendChild(row);
        });
        
        // Добавляем обработчики для кнопок
        document.querySelectorAll('.delete-blogger-btn').forEach(button => {
            button.addEventListener('click', function() {
                const bloggerId = this.getAttribute('data-id');
                if (confirm('Вы уверены, что хотите удалить этого блогера?')) {
                    deleteBlogger(bloggerId);
                }
            });
        });
    }
    
    function addBlogger() {
        const name = document.getElementById('blogger-name').value;
        const email = document.getElementById('blogger-email').value;
        const username = document.getElementById('blogger-telegram').value;
        
        if (!name) {
            alert('Пожалуйста, введите имя блогера');
            return;
        }
        
        const formData = new FormData();
        formData.append('name', name);
        formData.append('email', email);
        formData.append('username', username);
        
        fetch('/api/bloggers', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('add-blogger-modal').classList.add('hidden');
                document.getElementById('blogger-name').value = '';
                document.getElementById('blogger-email').value = '';
                document.getElementById('blogger-telegram').value = '';
                alert(`Блогер ${data.blogger.name} успешно добавлен!\nКлюч доступа: ${data.blogger.access_key}`);
                loadBloggers();
                loadStats();
            } else {
                alert('Ошибка при добавлении блогера: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка при добавлении блогера:', error);
            alert('Произошла ошибка при добавлении блогера');
        });
    }
    
    function deleteBlogger(bloggerId) {
        fetch(`/api/bloggers/${bloggerId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadBloggers();
                loadStats();
            } else {
                alert('Ошибка при удалении блогера: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка при удалении блогера:', error);
            alert('Произошла ошибка при удалении блогера');
        });
    }
</script>
{% endblock %}