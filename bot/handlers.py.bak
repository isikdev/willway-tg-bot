#!/usr/bin/env python
# -*- coding: utf-8 -*-
import os
import sys
import json
import requests
import logging
import telegram
import pytz 
from datetime import datetime, timedelta, timezone
from dotenv import load_dotenv
import time
import threading
from telegram.error import BadRequest
from telegram import ParseMode
import re
import types
import uuid
from pathlib import Path
from typing import Dict, List, Optional, Union, Any, Callable
import traceback
import random

load_dotenv()

TIMEZONE = pytz.timezone('Europe/Moscow')

sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from database.models import User, get_session, AdminUser, MessageHistory, ReferralCode, ReferralUse, ChatHistory, Payment
from bot.gpt_assistant import get_health_assistant_response

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, KeyboardButton, Bot, ChatAction
from telegram.ext import Updater, CallbackContext, CommandHandler, MessageHandler, CallbackQueryHandler, ConversationHandler, Filters
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–º–Ω–µ–Ω–∏–π –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ
from bot.subscription_doubt_handler import setup_subscription_doubt_handlers
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏
from bot.subscription_cancel_handler import get_cancel_subscription_button, setup_subscription_cancel_handlers

import colorlog

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è parse_mode
MARKDOWN = "Markdown"
HTML = "HTML"

media_folder = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'img')

def setup_colored_logging():
    handler = colorlog.StreamHandler(stream=sys.stdout)
    handler.setFormatter(colorlog.ColoredFormatter(
        '%(log_color)s%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        log_colors={
            'DEBUG': 'cyan',
            'INFO': 'green',
            'WARNING': 'yellow',
            'ERROR': 'red',
            'CRITICAL': 'red,bg_white',
        }
    ))
    
    file_handler = logging.FileHandler('payment_logs.log')
    file_handler.setFormatter(logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s'))
    
    logger = logging.getLogger('root')  # –ò–∑–º–µ–Ω—è–µ–º –Ω–∞ 'root', —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–≥–µ—Ä
    logger.setLevel(logging.INFO)
    
    for hdlr in logger.handlers[:]:
        logger.removeHandler(hdlr)
    
    logger.addHandler(handler)
    logger.addHandler(file_handler)
    
    return logger

logger = setup_colored_logging()

TOKEN = os.getenv('BOT_TOKEN')

(
    GENDER, 
    AGE, 
    HEIGHT, 
    WEIGHT, 
    MAIN_GOAL, 
    ADDITIONAL_GOAL, 
    WORK_FORMAT, 
    SPORT_FREQUENCY, 
    PAYMENT, 
    MAIN, 
    GPT_ASSISTANT,
    SUBSCRIPTION,
    SUPPORT,
    INVITE,
    MENU,
    SUPPORT_OPTIONS
) = range(16)

# API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
logger.info("API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã")

BOT_CONFIG_FILE = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'bot_config.json')

def fix_image_paths(config):
    updates = {}
    
    desc_pic_url = config.get('description_pic_url', '')
    if desc_pic_url:
        logger.info(f"–ù–∞–π–¥–µ–Ω –ø—É—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è: {desc_pic_url}")
        
        if desc_pic_url.startswith('/'):
            clean_path = desc_pic_url[1:]
        else:
            clean_path = desc_pic_url
            
        abs_path = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), clean_path)
        logger.info(f"–ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è: {abs_path}")
        
        if os.path.exists(abs_path):
            logger.info("–§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        else:
            logger.warning(f"–§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω: {abs_path}")
    
    video_url = config.get('intro_video_url', '')
    if video_url:
        logger.info(f"–ù–∞–π–¥–µ–Ω –ø—É—Ç—å –∫ –≤–∏–¥–µ–æ: {video_url}")
        
        if video_url.startswith('/'):
            clean_path = video_url[1:]
        else:
            clean_path = video_url
            
        abs_path = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), clean_path)
        logger.info(f"–ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –≤–∏–¥–µ–æ: {abs_path}")
        
        if os.path.exists(abs_path):
            logger.info("–§–∞–π–ª –≤–∏–¥–µ–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        else:
            logger.warning(f"–§–∞–π–ª –≤–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω: {abs_path}")
            # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    if updates:
        for key, value in updates.items():
            config[key] = value
    
    # –í–ê–ñ–ù–û–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–ï –î–õ–Ø –£–õ–£–ß–®–ï–ù–ò–Ø –ö–ê–ß–ï–°–¢–í–ê –í–ò–î–ï–û:
    # 1. –ü–æ–º–µ—Å—Ç–∏—Ç–µ –≤–∏–¥–µ–æ –≤—ã—Å–æ–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –≤ –ø–∞–ø–∫—É web_admin/static/video/ 
    # 2. –ù–∞–∑–æ–≤–∏—Ç–µ —Ñ–∞–π–ª intro_video.mp4
    # 3. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤–∏–¥–µ–æ: 1280x720 (HD)
    # 4. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –±–∏—Ç—Ä–µ–π—Ç: –Ω–µ –º–µ–Ω–µ–µ 2-3 –ú–±–∏—Ç/—Å
    # 5. –§–æ—Ä–º–∞—Ç: MP4 —Å –∫–æ–¥–µ–∫–æ–º H.264
    # 6. –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ –º–æ–∂–µ—Ç –≤–µ—Å–∏—Ç—å –¥–æ 20 –ú–ë
    # 7. –ü–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã —É–¥–∞–ª–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ 'intro_video_file_id' –∏–∑ bot_config.json,
    #    —á—Ç–æ–±—ã –±–æ—Ç –∑–∞–≥—Ä—É–∑–∏–ª –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ
    
    return config

# –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
def get_bot_config():
    """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–æ—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞"""
    logger.info("–ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞")
    # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞)
    BOT_CONFIG_FILE = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'bot_config.json')
    
    logger.info(f"–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {BOT_CONFIG_FILE}")
    logger.info(f"–§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {os.path.exists(BOT_CONFIG_FILE)}")
    
    config = {
        "trainer_username": "telegram",
        "manager_username": "telegram"
    }
    
    try:
        with open(BOT_CONFIG_FILE, 'r', encoding='utf-8') as f:
            loaded_config = json.load(f)
            config.update(loaded_config)
            logger.info(f"–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞: {config.keys()}")
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Ç–µ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            if 'description_pic_url' in config and config['description_pic_url']:
                path = config['description_pic_url']
                logger.info(f"–ù–∞–π–¥–µ–Ω –ø—É—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è: {path}")
                
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π
                if path.startswith('/'):
                    # –ï—Å–ª–∏ –ø—É—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å /, —É–±–∏—Ä–∞–µ–º –µ–≥–æ
                    path = path[1:]
                
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å
                abs_path = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), path)
                logger.info(f"–ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è: {abs_path}")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
                if os.path.exists(abs_path):
                    logger.info("–§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                    config['description_pic_absolute_path'] = abs_path
                else:
                    logger.warning(f"–§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {abs_path}")
            
            if 'botpic_url' in config and config['botpic_url']:
                path = config['botpic_url']
                logger.info(f"–ù–∞–π–¥–µ–Ω –ø—É—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–æ—Ç–∞: {path}")
                
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π
                if path.startswith('/'):
                    # –ï—Å–ª–∏ –ø—É—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å /, —É–±–∏—Ä–∞–µ–º –µ–≥–æ
                    path = path[1:]
                
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å
                abs_path = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), path)
                logger.info(f"–ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–æ—Ç–∞: {abs_path}")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
                if os.path.exists(abs_path):
                    logger.info("–§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–æ—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                    config['botpic_absolute_path'] = abs_path
                else:
                    logger.warning(f"–§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–æ—Ç–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {abs_path}")
                
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞: {e}")
    
    return config

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞
def apply_bot_config(bot, config):
    """–ü—Ä–∏–º–µ–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫ –±–æ—Ç—É"""
    logger.info("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞...")
    
    # –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    applied_settings = {
        "support_keyboard": False,
        "commands": False,
        "bot_name": False,
        "about_text": False,
        "description": False,
        "privacy_mode": False,
        "description_pic": False,
        "botpic": False
    }
    
    try:
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ API Telegram
        if 'commands' in config and isinstance(config['commands'], dict):
            bot_commands = []
            for cmd, desc in config.get('commands', {}).items():
                # –£–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª "/" –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –∫–æ–º–∞–Ω–¥—ã
                cmd_name = cmd[1:] if cmd.startswith('/') else cmd
                bot_commands.append((cmd_name, desc))
            
            if bot_commands:
                try:
                    # –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ä—Å–∏–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –º–µ—Ç–æ–¥—ã
                    # –î–ª—è python-telegram-bot 13.x
                    bot.set_my_commands(bot_commands)
                    applied_settings["commands"] = True
                    logger.info(f"–û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞: {bot_commands}")
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞: {e}")
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è –±–æ—Ç–∞ —á–µ—Ä–µ–∑ BotFather —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ API
        # –≠—Ç–æ –Ω–µ–ª—å–∑—è —Å–¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ python-telegram-bot
        # –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ, –º—ã –º–æ–∂–µ–º –≤—ã–≤–µ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
        
        # –í –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π API Telegram
        # –ù–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É—è requests –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API:
        # response = requests.post(f"https://api.telegram.org/bot{TOKEN}/setMyName", 
        #    data={"name": config.get('bot_name')})
        
        # –î–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞ –ª–µ—Ç—É –≤ –∫–æ–¥–µ
        if 'privacy_mode' in config:
            # –ù–∞–ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–æ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É, –∫–æ—Ç–æ—Ä–∞—è –≤–ª–∏—è–µ—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
            # –±–æ—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
            applied_settings["privacy_mode"] = True
            logger.info(f"–û–±–Ω–æ–≤–ª–µ–Ω —Ä–µ–∂–∏–º –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏: {config.get('privacy_mode')}")
        
        # –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–º–µ–Ω–∏, –æ–ø–∏—Å–∞–Ω–∏—è –∏ —Ç.–¥. –º–æ–∂–Ω–æ –∫–∞–∫-—Ç–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –±–æ—Ç—É,
        # —Ç–æ –∫–æ–¥ –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–¥–µ—Å—å
        
        return applied_settings
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫ –±–æ—Ç—É: {e}")
        return applied_settings

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
def get_webapp_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –≤–µ–±-—Å–∞–π—Ç–∞"""
    webapp_button = InlineKeyboardButton(
        text="–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", 
        url="https://willway.pro/members/signup"
    )
    return InlineKeyboardMarkup([[webapp_button]])

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–ª–∞–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å)
def get_main_keyboard():
    keyboard = [
        [KeyboardButton("Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç"), KeyboardButton("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π")],
        [KeyboardButton("–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π"), KeyboardButton("–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞")]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –æ–ø–ª–∞—Ç—ã —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ URL
def get_payment_keyboard(user_id, context=None):
    # –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    payment_url = "https://willway.pro/payment"
    
    # –î–æ–±–∞–≤–ª—è–µ–º UTM-–º–µ—Ç–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    payment_url = f"{payment_url}?tgid={user_id}"
    
    # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –æ–ø–ª–∞—Ç–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã
    # –°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
    
    keyboard = [
        [InlineKeyboardButton("–í–∞—Ä–∏–∞–Ω—Ç—ã WILLWAY –ø–æ–¥–ø–∏—Å–∫–∏", callback_data="show_subscription_options")]
    ]
    return InlineKeyboardMarkup(keyboard)

def menu_keyboard():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
    return [
        [InlineKeyboardButton("Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç", callback_data="health_assistant")],
        [InlineKeyboardButton("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π", callback_data="subscription_management")],
        [InlineKeyboardButton("–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π", callback_data="support")],
        [InlineKeyboardButton("–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞", callback_data="invite_friend")]
    ]

def support_keyboard():
    # –ö–∞–∂–¥—ã–π —Ä–∞–∑ —á–∏—Ç–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ
    config = get_bot_config()
    trainer_username = config.get("trainer_username", "willway_trainer")
    manager_username = config.get("manager_username", "willway_manager")
    
    # –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    logger.info(f"–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è username: —Ç—Ä–µ–Ω–µ—Ä - {trainer_username}, –º–µ–Ω–µ–¥–∂–µ—Ä - {manager_username}")
    
    keyboard = [
        [InlineKeyboardButton("–í–æ–ø—Ä–æ—Å –º–µ–Ω–µ–¥–∂–µ—Ä—É", url=f"https://t.me/{manager_username}")],
        [InlineKeyboardButton("–í–æ–ø—Ä–æ—Å —Ç—Ä–µ–Ω–µ—Ä—É", url=f"https://t.me/{trainer_username}")],
        [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]
    ]
    return InlineKeyboardMarkup(keyboard)

# –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
def clear(update: Update, context: CallbackContext) -> int:
    """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏."""
    user_id = update.effective_user.id
    
    # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    session = get_session()
    user = session.query(User).filter(User.user_id == user_id).first()
    
    if user:
        session.delete(user)
        session.commit()
        update.message.reply_text("–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–æ–≤–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
    else:
        update.message.reply_text("–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
    
    session.close()
    return ConversationHandler.END

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
def reload_config(update: Update, context: CallbackContext) -> int:
    """–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–æ—Ç–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞."""
    user_id = update.effective_user.id
    logger.info(f"–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ /reload_config –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–º–µ–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∞–≤–æ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã (–∞–¥–º–∏–Ω)
    session = get_session()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ –∞–¥–º–∏–Ω–æ–≤
    admin = session.query(AdminUser).filter(AdminUser.user_id == user_id).first()
    
    logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –≤ –∞–¥–º–∏–Ω–∞—Ö - {admin is not None}")
    
    if not admin:
        # –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ is_admin
        user = session.query(User).filter(User.user_id == user_id).first()
        if user and user.is_admin:
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞–π–¥–µ–Ω –∫–∞–∫ –∞–¥–º–∏–Ω —á–µ—Ä–µ–∑ —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ –ø–æ–ª–µ is_admin")
            # –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –∞–¥–º–∏–Ω–æ–≤ –¥–ª—è –±—É–¥—É—â–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
            new_admin = AdminUser(user_id=user_id, username=update.effective_user.username)
            session.add(new_admin)
            session.commit()
        else:
            logger.warning(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø—ã—Ç–∞–ª—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /reload_config –±–µ–∑ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
            update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
            session.close()
            return ConversationHandler.END
    
    # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é")
    config = get_bot_config()
    logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: {config}")
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∫ –±–æ—Ç—É
    try:
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –±–æ—Ç—É
        applied_settings = apply_bot_config(context.bot, config)
        
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        config_info = [
            "‚úÖ *–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞!*\n",
            f"ü§ñ *–ò–º—è –±–æ—Ç–∞:* {config.get('bot_name', 'WillWay Bot')}",
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–± "–û –±–æ—Ç–µ" —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if config.get('about_text'):
            config_info.append(f"‚ÑπÔ∏è *–û –±–æ—Ç–µ:* {config.get('about_text')}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        if config.get('description'):
            config_info.append(f"üìù *–û–ø–∏—Å–∞–Ω–∏–µ:* {config.get('description')}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–Ω–∞–ª–µ
        channel_url = config.get('channel_url')
        if channel_url:
            config_info.append(f"\nüì¢ *–ö–∞–Ω–∞–ª –±–æ—Ç–∞:* {channel_url}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–µ–Ω–µ—Ä–µ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–µ
        config_info.append(f"\nüë®‚Äçüè´ *–¢—Ä–µ–Ω–µ—Ä:* @{config.get('trainer_username', '–Ω–µ —É–∫–∞–∑–∞–Ω')}")
        config_info.append(f"üë®‚Äçüíº *–ú–µ–Ω–µ–¥–∂–µ—Ä:* @{config.get('manager_username', '–Ω–µ —É–∫–∞–∑–∞–Ω')}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–∞–Ω–¥–∞—Ö
        if 'commands' in config and config['commands']:
            config_info.append("\n*–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:*")
            for cmd, desc in config.get('commands', {}).items():
                config_info.append(f"{cmd} - {desc}")
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
            status = "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã" if applied_settings.get("commands", False) else "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å"
            config_info.append(f"_–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞: {status}_")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
        privacy_mode = "–í–∫–ª—é—á–µ–Ω" if config.get('privacy_mode', False) else "–í—ã–∫–ª—é—á–µ–Ω"
        config_info.append(f"\nüîí *–†–µ–∂–∏–º –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏:* {privacy_mode}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        update.message.reply_text(
            "\n".join(config_info),
            parse_mode=ParseMode.MARKDOWN
        )
        logger.info(f"–û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞: {e}")
        update.message.reply_text(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {str(e)}")
    
    session.close()
    return ConversationHandler.END

# –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å GPT
user_conversations = {}

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç"
def health_assistant_button(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç"""
    if update.message:
        message = update.message
        user_id = message.from_user.id
    else:
        query = update.callback_query
        query.answer()
        message = query.message
        user_id = query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    is_subscribed = update_subscription_status(user_id, context)
    
    if not is_subscribed:
        if update.message:
            message.reply_text(
                "–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.",
                reply_markup=get_payment_keyboard_inline(user_id)
            )
        else:
            context.bot.send_message(
                chat_id=user_id,
                text="–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.",
                reply_markup=get_payment_keyboard_inline(user_id)
            )
        return
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    context.user_data['health_assistant_active'] = True
    logger.info(f"–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–µ–∂–∏–º Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    
    # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    if update.message:
        message.reply_text(
            "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –∏ –º–µ–Ω—Ç–∞–ª—å–Ω–æ–º –∑–¥–æ—Ä–æ–≤—å–µ. "
            "–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Ç–µ–±–µ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö, –ø–∏—Ç–∞–Ω–∏–∏ –∏ –æ–±—â–µ–º –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–∏. "
            "–ü—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç.\n\n"
            "–ß—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É '–ù–∞–∑–∞–¥'.",
            reply_markup=ReplyKeyboardMarkup([["–ù–∞–∑–∞–¥"]], resize_keyboard=True)
        )
    else:
        context.bot.send_message(
            chat_id=user_id,
            text="–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –∏ –º–µ–Ω—Ç–∞–ª—å–Ω–æ–º –∑–¥–æ—Ä–æ–≤—å–µ. "
            "–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Ç–µ–±–µ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö, –ø–∏—Ç–∞–Ω–∏–∏ –∏ –æ–±—â–µ–º –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–∏. "
            "–ü—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç.\n\n"
            "–ß—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É '–ù–∞–∑–∞–¥'.",
            reply_markup=ReplyKeyboardMarkup([["–ù–∞–∑–∞–¥"]], resize_keyboard=True)
        )
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    if user_id not in user_conversations:
        user_conversations[user_id] = []

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def get_user_conversation_history(user_id, limit=10):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
        limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è (–ø–∞—Ä –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç)
        
    Returns:
        list: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è OpenAI API
    """
    session = get_session()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    messages = session.query(MessageHistory)\
        .filter(MessageHistory.user_id == user_id)\
        .order_by(MessageHistory.timestamp.desc())\
        .limit(limit * 2)\
        .all()
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è OpenAI API –∏ –º–µ–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –Ω–∞ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π
    conversation_history = [
        {"role": msg.role, "content": msg.content}
        for msg in sorted(messages, key=lambda x: x.timestamp)
    ]
    
    session.close()
    return conversation_history

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
def save_message_to_history(user_id, role, content):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
        role: –†–æ–ª—å ('user' –∏–ª–∏ 'assistant')
        content: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    """
    session = get_session()
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    message = MessageHistory(
        user_id=user_id,
        role=role,
        content=content
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    session.add(message)
    session.commit()
    session.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–µ–∂–∏–º–µ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
def handle_health_assistant_message(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏
    if context.user_data.get('cancellation', {}).get('active', False):
        logger.info(f"–ü—Ä–æ–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º - –∞–∫—Ç–∏–≤–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏")
        return
        
    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if update.callback_query:
        message = update.callback_query.message
        user_id = update.callback_query.from_user.id
        user_message = update.callback_query.message.text
    else:
        message = update.message
        user_id = message.from_user.id
        user_message = message.text
    
    # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ handle_text_messages
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    is_subscribed = update_subscription_status(user_id, context)
    
    if not is_subscribed:
        # –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ñ–æ—Ä–º–∏—Ç—å
        response = "–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É."
        
        if update.callback_query:
            update.callback_query.message.reply_text(
                response,
                reply_markup=get_payment_keyboard_inline(user_id)
            )
        else:
            message.reply_text(
                response,
                reply_markup=get_payment_keyboard_inline(user_id)
            )
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        context.user_data['health_assistant_active'] = False
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
    context.bot.send_chat_action(chat_id=user_id, action=ChatAction.TYPING)
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        conversation_history = get_user_conversation_history(user_id, limit=5)
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç GPT
        response = get_health_assistant_response(
            user_id, 
            user_message, 
            conversation_history
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–≤–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        save_message_to_history(user_id, "user", user_message)
        save_message_to_history(user_id, "assistant", response)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        if update.callback_query:
            update.callback_query.message.reply_text(
                response,
                reply_markup=ReplyKeyboardMarkup([["–ù–∞–∑–∞–¥"]], resize_keyboard=True)
            )
        else:
            message.reply_text(
                response,
                reply_markup=ReplyKeyboardMarkup([["–ù–∞–∑–∞–¥"]], resize_keyboard=True)
            )
            
        # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        context.user_data['health_assistant_active'] = True
        logger.info(f"[HEALTH] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É: {e}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        error_message = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        
        if update.callback_query:
            update.callback_query.message.reply_text(
                error_message,
                reply_markup=ReplyKeyboardMarkup([["–ù–∞–∑–∞–¥"]], resize_keyboard=True)
            )
        else:
            message.reply_text(
                error_message,
                reply_markup=ReplyKeyboardMarkup([["–ù–∞–∑–∞–¥"]], resize_keyboard=True)
            )
            
    return

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" (–Ω–µ –æ—á–∏—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö)
def back_to_main_menu(update: Update, context: CallbackContext):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    user_id = update.effective_user.id
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ (callback –∏–ª–∏ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
    is_callback = update.callback_query is not None
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if context.user_data.get('health_assistant_active'):
        context.user_data['health_assistant_active'] = False
        logger.info(f"–°–±—Ä–æ—à–µ–Ω —Ñ–ª–∞–≥ health_assistant_active –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –º–µ–Ω—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–Ω–∫–µ—Ç—É
    session = get_session()
    try:
        user = session.query(User).filter(User.user_id == user_id).first()
        
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –∞–Ω–∫–µ—Ç–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞
        if user and not user.registered:
            logger.info(f"[SURVEY_REQUIRED] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ–Ω—é –±–µ–∑ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∞–Ω–∫–µ—Ç—ã")
            
            # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É
            keyboard = [
                [InlineKeyboardButton("–ü–æ–¥–æ–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É", callback_data="start_survey")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            if is_callback:
                query = update.callback_query
                query.answer()
                query.edit_message_text(
                    "–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É:",
                    reply_markup=reply_markup
                )
            else:
                update.message.reply_text(
                    "–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É:",
                    reply_markup=reply_markup
                )
            
            session.close()
            return ConversationHandler.END
        
        session.close()
        
        # –ï—Å–ª–∏ –∞–Ω–∫–µ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤–Ω–∏–∑—É
        if is_callback:
            query = update.callback_query
            query.answer()
            
            # –°–Ω–∞—á–∞–ª–∞ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å inline –∫–Ω–æ–ø–∫–∏
            try:
                query.edit_message_text("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            
            # –ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤–Ω–∏–∑—É
            context.bot.send_message(
                chat_id=user_id,
                text="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                reply_markup=get_main_keyboard()
            )
        else:
            update.message.reply_text(
                "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                reply_markup=get_main_keyboard()
            )
        
        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        context.user_data.clear()
        
        return MAIN
    except Exception as e:
        logger.error(f"[SURVEY_CHECK_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–Ω–∫–µ—Ç—ã: {e}")
        if 'session' in locals() and session:
            session.close()
        
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
        if is_callback:
            try:
                query = update.callback_query
                query.answer()
                
                # –ü—Ä–æ–±—É–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                try:
                    query.edit_message_text("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:")
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
                context.bot.send_message(
                    chat_id=user_id,
                    text="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                    reply_markup=get_main_keyboard()
                )
            except Exception as edit_error:
                logger.error(f"[MENU_ERROR] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {edit_error}")
                if update.message:
                    update.message.reply_text(
                        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                        reply_markup=get_main_keyboard()
                    )
        else:
            update.message.reply_text(
                "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                reply_markup=get_main_keyboard()
            )
        
        return MAIN

def start(update: Update, context: CallbackContext) -> int:
    user_id = update.effective_user.id
    username = update.effective_user.username
    chat_id = update.effective_chat.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ–º–∞–Ω–¥–µ /start
    args = context.args
    referral_code = args[0] if args else None
    
    logger.info(f"[START] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤—ã–∑–≤–∞–ª –∫–æ–º–∞–Ω–¥—É /start —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏: {args}")
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
    if referral_code and referral_code.startswith('payment_success_'):
        try:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
            payment_user_id = referral_code.replace('payment_success_', '')
            logger.info(f"[PAYMENT_SUCCESS] –ü–æ–ª—É—á–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {payment_user_id}")
            
            # –ï—Å–ª–∏ ID –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if str(payment_user_id) == str(user_id):
                # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                session = get_session()
                user = session.query(User).filter(User.user_id == user_id).first()
                
                if user:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É–∂–µ –ø–æ–¥–ø–∏—Å–∫–∞
                    if not user.is_subscribed or (user.subscription_expires and user.subscription_expires < datetime.now(TIMEZONE)):
                        # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –º–µ—Å—è—á–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
                        user.is_subscribed = True
                        user.subscription_type = "monthly"
                        user.subscription_expires = datetime.now(TIMEZONE) + timedelta(days=30)
                        user.payment_status = "completed"
                        
                        session.commit()
                        logger.info(f"[PAYMENT_SUCCESS] –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                        
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
                        update.message.reply_text(
                            "üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.\n\n"
                            "–¢–µ–ø–µ—Ä—å –≤–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞, –≤–∫–ª—é—á–∞—è Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã.",
                            reply_markup=get_main_keyboard()
                        )
                        
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
                        send_successful_payment_messages(update, context, "active")
                    else:
                        logger.info(f"[PAYMENT_SUCCESS] –ü–æ–¥–ø–∏—Å–∫–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                        update.message.reply_text(
                            "–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞! –°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.",
                            reply_markup=get_main_keyboard()
                        )
                    
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
                    update.message.reply_text(
                        "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
                        reply_markup=InlineKeyboardMarkup(menu_keyboard())
                    )
                    
                    session.close()
                    return ConversationHandler.END
                
                session.close()
            else:
                logger.warning(f"[PAYMENT_SUCCESS] –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: –ø–∞—Ä–∞–º–µ—Ç—Ä {payment_user_id}, —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π {user_id}")
        except Exception as e:
            logger.error(f"[PAYMENT_SUCCESS] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã: {str(e)}")
    
    if referral_code:
        logger.info(f"[REFERRAL] –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: {referral_code}")
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    session = get_session()
    user_created = False
    ref_code = None  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é ref_code
    
    try:
        user = session.query(User).filter(User.user_id == user_id).first()
        
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π, —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
        if not user:
            user_created = True
            user = User(
                user_id=user_id,
                username=username,
                registration_date=datetime.now(TIMEZONE),
                first_interaction_time=datetime.now(TIMEZONE),
                registered=False  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–æ—à–µ–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
            )
            
            # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
            if referral_code:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
                ref_code = session.query(ReferralCode).filter(ReferralCode.code == referral_code, ReferralCode.is_active == True).first()
                if ref_code and str(ref_code.user_id) != str(user_id):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —Å—Ç—Ä–æ–∫–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                    logger.info(f"[REFERRAL] –ù–∞–π–¥–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: {referral_code}, –≤–ª–∞–¥–µ–ª–µ—Ü: {ref_code.user_id}")
                    
                    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≥–ª–∞—Å–∏–ª —Ç–µ–∫—É—â–µ–≥–æ)
                    referrer = session.query(User).filter_by(id=ref_code.user_id).first()
                    if not referrer:
                        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ ID, –∏—â–µ–º –ø–æ telegram_id
                        referrer_telegram_id = session.query(User).filter_by(user_id=ref_code.user_id).first()
                        if referrer_telegram_id:
                            referrer = referrer_telegram_id
                    
                    if referrer:
                        logger.info(f"[REFERRAL] –ù–∞–π–¥–µ–Ω —Ä–µ—Ñ–µ—Ä–µ—Ä: id={referrer.id}, user_id={referrer.user_id}, username={referrer.username}")
                        
                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤—è–∑—å –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
                        user.referrer_id = referrer.user_id
                        user.referral_source = 'link'
                        
                        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ ID
                        session.add(user)
                        session.flush()  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID
                        
                        logger.info(f"[REFERRAL] –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏: code_id={ref_code.id}, user_id={user.id}, referrer_id={referrer.id}")
                        
                        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
                        try:
                            ref_use = ReferralUse(
                                    code_id=ref_code.id,  # –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è
                                    user_id=user.id,
                                    referrer_id=referrer.id,
                                    created_at=datetime.now(),  # –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è
                                    subscription_purchased=False
                            )
                            session.add(ref_use)
                            logger.info(f"[REFERRAL] –°–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π")
                        except Exception as ref_use_error:
                            logger.error(f"[REFERRAL_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π: {str(ref_use_error)}")
                            # –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å —Å –ø—Ä–µ–∂–Ω–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
                            try:
                                ref_use = ReferralUse(
                                    referral_code_id=ref_code.id,
                                    user_id=user.id,
                                    referrer_id=referrer.id,
                                    referred_id=int(user_id),  # –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                                    used_at=datetime.now(),
                                    subscription_purchased=False,
                                    status='registered'  # –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                                )
                                session.add(ref_use)
                                logger.info(f"[REFERRAL] –°–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ —Å–æ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π")
                            except Exception as old_error:
                                logger.error(f"[REFERRAL_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ —Å–æ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π: {str(old_error)}")
                        
                        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –∫–æ–¥–∞
                        try:
                            if hasattr(ref_code, 'total_uses'):
                                ref_code.total_uses += 1
                                logger.info(f"[REFERRAL] –£–≤–µ–ª–∏—á–µ–Ω —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –∫–æ–¥–∞")
                        except Exception as counter_error:
                            logger.warning(f"[REFERRAL_WARNING] –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–ª–∏—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π: {str(counter_error)}")
                        
                        logger.info(f"[REFERRAL] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø—Ä–∏—à–µ–ª –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {referrer.user_id}")
                    else:
                        logger.warning(f"[REFERRAL] –†–µ—Ñ–µ—Ä–µ—Ä —Å user_id={ref_code.user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
                        user.referral_source = 'unknown'
                else:
                    if ref_code:
                        logger.info(f"[REFERRAL] –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Å–∞–º–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω")
                    else:
                        logger.info(f"[REFERRAL] –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ {referral_code} –Ω–µ –Ω–∞–π–¥–µ–Ω")
                    user.referral_source = 'direct'
                    logger.info(f"[REFERRAL] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: {referral_code}")
            else:
                user.referral_source = 'direct'
                logger.info(f"[REFERRAL] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø—Ä–∏—à–µ–ª –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞")
        
        session.add(user)
        session.commit()
        
        if user_created:
            logger.info(f"–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}")
    except Exception as e:
        session.rollback()
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã /start: {str(e)}")
        logger.exception(e)
    finally:
        session.close()
    
    user = None
    
    try:
        session = get_session()
        user = session.query(User).filter(User.user_id == user_id).first()
        session.close()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {str(e)}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π –∏–ª–∏ –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
    if user and not user.registered:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
        send_welcome_video(update, context)
        
        # –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —ç—Ç–æ–º
        if is_admin(user_id):
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º")
            update.message.reply_text(
                "–í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /admin –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.",
                reply_markup=get_main_keyboard()
            )
            return ConversationHandler.END
        
        # –ë–æ–ª—å—à–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å
        # –∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        
        return ConversationHandler.END
    else:
        # –î–ª—è —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        update.message.reply_text(
            "–†–∞–¥ –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é:",
            reply_markup=get_main_keyboard()
        )
                
        update.message.reply_text(
            "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
            reply_markup=InlineKeyboardMarkup(menu_keyboard())
        )
        
        if user and user.payment_status == 'pending' and not user.is_subscribed:
            schedule_payment_reminder(context, user_id)
        
        return ConversationHandler.END

def send_welcome_video(update, context):
    config = get_bot_config()
    
    keyboard = [
        [InlineKeyboardButton("–ü–æ–¥–æ–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É", callback_data="start_survey")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    caption = "–ú—ã –∑–Ω–∞–µ–º, –∫–∞–∫ —É–ª—É—á—à–∏—Ç—å —Ç–≤–æ—ë –∑–¥–æ—Ä–æ–≤—å–µ, —Ç–µ–ª–æ, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∫–∞—á–µ—Å—Ç–≤–æ –∂–∏–∑–Ω–∏\n\n–î–∞–π –Ω–∞–º 2 –º–∏–Ω—É—Ç—ã, –∏ –º—ã –ø–æ–∫–∞–∂–µ–º –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    
    try:
        video_file_id = config.get('intro_video_file_id')
        
        video_settings = config.get('video_settings', {})
        width = video_settings.get('width', 1280)
        height = video_settings.get('height', 720)
        supports_streaming = video_settings.get('supports_streaming', True)
        timeout = video_settings.get('timeout', 120)
        disable_notification = video_settings.get('disable_notification', False)
        
        if video_file_id:
            logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π file_id –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ: {video_file_id}")
            
            try:
                update.message.reply_video(
                    video=video_file_id,
                    caption=caption,
                    timeout=timeout,
                    width=width,
                    height=height,
                    supports_streaming=supports_streaming,
                    disable_notification=disable_notification,
                    parse_mode=telegram.ParseMode.HTML,
                    reply_markup=reply_markup
                )
                return
            except Exception as vid_err:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ file_id: {vid_err}. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –∑–∞–Ω–æ–≤–æ.")
        
        video_path = config.get('intro_video_url', '')
        
        if video_path and video_path.startswith('/'):
            clean_path = video_path[1:]
            abs_path = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), clean_path)
            logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ –∏–∑: {abs_path}")
            
            if os.path.exists(abs_path):
                logger.info(f"–í–∏–¥–µ–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º...")
                try:
                    message = update.message.reply_video(
                        video=open(abs_path, 'rb'),
                        caption=caption,
                        timeout=timeout,
                        width=width,
                        height=height,
                        supports_streaming=supports_streaming,
                        disable_notification=disable_notification,
                        parse_mode=telegram.ParseMode.HTML,
                        reply_markup=reply_markup
                    )
                    
                    if message and message.video:
                        new_file_id = message.video.file_id
                        logger.info(f"–ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π file_id –¥–ª—è –≤–∏–¥–µ–æ: {new_file_id}")
                        
                        try:
                            config['intro_video_file_id'] = new_file_id
                            save_bot_config(config)
                            logger.info("File ID –≤–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏")
                        except Exception as save_err:
                            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ file_id –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {save_err}")
                except telegram.error.NetworkError as network_err:
                    logger.error(f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–∏–¥–µ–æ: {network_err}")
                    update.message.reply_text(
                        caption,
                        reply_markup=reply_markup
                    )
                except telegram.error.TimedOut as timeout_err:
                    logger.error(f"–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–∏–¥–µ–æ: {timeout_err}")
                    update.message.reply_text(
                        caption,
                        reply_markup=reply_markup
                    )
                except Exception as e:
                    logger.error(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–∏–¥–µ–æ: {e}")
                    update.message.reply_text(
                        caption,
                        reply_markup=reply_markup
                    )
            else:
                logger.error(f"–§–∞–π–ª –≤–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: {abs_path}")
                update.message.reply_text(
                    caption,
                    reply_markup=reply_markup
                )
        else:
            logger.error(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—É—Ç—å –∫ –≤–∏–¥–µ–æ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {video_path}")
            update.message.reply_text(
                caption,
                reply_markup=reply_markup
            )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–∏–¥–µ–æ: {e}")
        update.message.reply_text(
            caption,
            reply_markup=reply_markup
        )

def send_survey_prompt(context: CallbackContext):
    # –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    # –ü—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
    logger.info(f"send_survey_prompt –≤—ã–∑–≤–∞–Ω, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–æ–≤—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º")
    # –û—Å—Ç–∞–≤–ª—è–µ–º —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –ø—É—Å—Ç–æ–π, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    return

def start_survey(update: Update, context: CallbackContext) -> int:

    if update.callback_query:
        query = update.callback_query
        query.answer()  # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback
        user_id = query.from_user.id
        chat_id = query.message.chat_id
    else:
        user_id = update.message.from_user.id
        chat_id = update.message.chat_id
    
    logger.info(f"[SURVEY] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—É—Å—Ç–∏–ª –∞–Ω–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")
    
    session = get_session()
    try:
        user = session.query(User).filter(User.user_id == user_id).first()
        
        if user and user.registered:
            logger.info(f"[SURVEY] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É–∂–µ –∑–∞–ø–æ–ª–Ω–∏–ª –∞–Ω–∫–µ—Ç—É —Ä–∞–Ω–µ–µ")
            
            message_text = (
                "–¢—ã —É–∂–µ –∑–∞–ø–æ–ª–Ω–∏–ª –∞–Ω–∫–µ—Ç—É! –¢–≤–æ–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã.\n\n"
                "–¢—ã –º–æ–∂–µ—à—å –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥—Ä—É–≥–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –±–æ—Ç–∞."
            )
            
            if update.callback_query:
                query.edit_message_text(
                    text=message_text,
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton("–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é", callback_data="back_to_menu")]
                    ])
                )
            else:
                update.message.reply_text(
                    message_text,
                    reply_markup=get_main_keyboard()
                )
            
            return ConversationHandler.END
    except Exception as e:
        logger.error(f"[SURVEY] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–Ω–∫–µ—Ç—ã: {e}")
    finally:
        session.close()
    
    context.user_data['bot_messages'] = []
    
    keyboard = [
        [InlineKeyboardButton("–ú—É–∂—Å–∫–æ–π", callback_data="male")],
        [InlineKeyboardButton("–ñ–µ–Ω—Å–∫–∏–π", callback_data="female")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ 1_POL.jpg –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    image_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'img', '1_POL.jpg')
    
    try:
        if os.path.exists(image_path):
            with open(image_path, 'rb') as photo:
                if update.callback_query:
                    bot_message = context.bot.send_photo(
                        chat_id=chat_id,
                        photo=photo,
                        caption="–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:",
                        reply_markup=reply_markup
                    )
                else:
                    bot_message = context.bot.send_photo(
                        chat_id=chat_id,
                        photo=photo,
                        caption="–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:",
                        reply_markup=reply_markup
                    )
                logger.info(f"[SURVEY_START] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ç–æ —Å –∑–∞–ø—Ä–æ—Å–æ–º –ø–æ–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        else:
            logger.warning(f"[SURVEY_ERROR] –§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω: {image_path}")
            if update.callback_query:
                bot_message = context.bot.send_message(
                    chat_id=chat_id,
                    text=f"–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:",
                    reply_markup=reply_markup
                )
            else:
                bot_message = context.bot.send_message(
                    chat_id=chat_id,
                    text=f"–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:",
                    reply_markup=reply_markup
                )
    except Exception as e:
        logger.error(f"[SURVEY_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª–∞: {e}")
        if update.callback_query:
            bot_message = context.bot.send_message(
                chat_id=chat_id,
                text=f"–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:",
                reply_markup=reply_markup
            )
        else:
            bot_message = context.bot.send_message(
                chat_id=chat_id,
                text=f"–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:",
                reply_markup=reply_markup
            )
    
    context.user_data['bot_messages'].append(bot_message.message_id)
    
    return GENDER

def gender(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    query.answer()
    
    user_gender = query.data
    user_id = update.effective_user.id
    message_id = query.message.message_id
    
    logger.info(f"[SURVEY_GENDER_DEBUG] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤—ã–±—Ä–∞–ª –ø–æ–ª: {user_gender}, message_id: {message_id}")
    
    context.user_data['gender'] = "–ú—É–∂—Å–∫–æ–π" if user_gender == "male" else "–ñ–µ–Ω—Å–∫–∏–π"
    logger.info(f"[SURVEY_GENDER] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤—ã–±—Ä–∞–ª –ø–æ–ª: {context.user_data['gender']}")
    
    try:
        session = get_session()
        user = session.query(User).filter(User.user_id == user_id).first()
        if user:
            user.gender = context.user_data['gender']
            session.commit()
            logger.info(f"[SURVEY_GENDER] –î–∞–Ω–Ω—ã–µ –æ –ø–æ–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î")
        session.close()
    except Exception as e:
        logger.error(f"[SURVEY_GENDER_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª–∞ –≤ –ë–î: {e}")
        if 'session' in locals() and session:
            session.close()
    
    try:
        context.bot.delete_message(chat_id=user_id, message_id=message_id)
        logger.info(f"[SURVEY_GENDER] –£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –ø–æ–ª–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    except Exception as e:
        logger.error(f"[SURVEY_GENDER_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π: {e}")
    
    try:
        image_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'img', '2_VOZRAST.jpg')
        
        if os.path.exists(image_path):
            with open(image_path, 'rb') as photo:
                sent_message = context.bot.send_photo(
                    chat_id=user_id,
                    photo=photo,
                    caption="–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏ —Å–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç (–ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —á–∏—Å–ª–æ):"
                )
        else:
            sent_message = context.bot.send_message(
                chat_id=user_id,
                text="–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏ —Å–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç (–ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —á–∏—Å–ª–æ):"
            )
        
        context.user_data['bot_messages'] = [sent_message.message_id]
        logger.info(f"[SURVEY_AGE_REQUEST] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}, message_id: {sent_message.message_id}")
    except Exception as e:
        logger.error(f"[SURVEY_ERROR] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–æ–ø—Ä–æ—Å–∞ –æ –≤–æ–∑—Ä–∞—Å—Ç–µ: {e}")
        try:
            context.bot.send_message(
                chat_id=user_id,
                text="–£–∫–∞–∂–∏ —Å–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç (—á–∏—Å–ª–æ):"
            )
        except:
            logger.error(f"[SURVEY_ERROR] –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            return ConversationHandler.END
    
    logger.info(f"[SURVEY_TRANSITION] –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É AGE –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    return AGE

def age(update: Update, context: CallbackContext) -> int:
    user_id = update.effective_user.id
    logger.info(f"[SURVEY_AGE] –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {update.message.text}")
    
    try:
        user_age = int(update.message.text.strip())
        
        if user_age < 10 or user_age > 100:
            update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —Ä–µ–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –æ—Ç 10 –¥–æ 100 –ª–µ—Ç:")
            logger.warning(f"[SURVEY_AGE] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤–≤–µ–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç: {user_age}")
            return AGE
            
        context.user_data['age'] = user_age
        logger.info(f"[SURVEY_AGE] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É–∫–∞–∑–∞–ª –≤–æ–∑—Ä–∞—Å—Ç: {user_age}")
        
        user_message_id = update.message.message_id
        
        try:
            session = get_session()
            user = session.query(User).filter(User.user_id == user_id).first()
            if user:
                user.age = user_age
                session.commit()
                logger.info(f"[SURVEY_AGE] –í–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î")
            session.close()
        except Exception as e:
            logger.error(f"[SURVEY_AGE_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–æ–∑—Ä–∞—Å—Ç–∞ –≤ –ë–î: {e}")
            if 'session' in locals() and session:
                session.close()
        
        if 'bot_messages' in context.user_data:
            for msg_id in context.user_data['bot_messages']:
                try:
                    context.bot.delete_message(
                        chat_id=update.message.chat_id,
                        message_id=msg_id
                    )
                except Exception as e:
                    logger.error(f"[SURVEY_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞: {e}")
        
        image_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'img', '3_ROST.jpg')
        
        try:
            context.bot.delete_message(
                chat_id=update.message.chat_id,
                message_id=user_message_id
            )
        except Exception as e:
            logger.error(f"[SURVEY_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        
        context.user_data['bot_messages'] = []
        
        try:
            if os.path.exists(image_path):
                with open(image_path, 'rb') as photo:
                    bot_message = context.bot.send_photo(
                        chat_id=user_id,
                        photo=photo,
                        caption="–°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏ —Å–≤–æ–π —Ä–æ—Å—Ç\n–≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö (–ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —á–∏—Å–ª–æ):"
                    )
                    
                    context.user_data['bot_messages'].append(bot_message.message_id)
            else:
                logger.warning(f"[SURVEY_ERROR] –§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω: {image_path}")
                bot_message = context.bot.send_message(
                    chat_id=user_id,
                    text="–°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏ —Å–≤–æ–π —Ä–æ—Å—Ç\n–≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö (–ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —á–∏—Å–ª–æ):"
                )
                
                context.user_data['bot_messages'].append(bot_message.message_id)
        except Exception as e:
            logger.error(f"[SURVEY_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –æ —Ä–æ—Å—Ç–µ: {e}")
            bot_message = context.bot.send_message(
                chat_id=user_id,
                text="–°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏ —Å–≤–æ–π —Ä–æ—Å—Ç\n–≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö (–ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —á–∏—Å–ª–æ):"
            )
        
        logger.info(f"[SURVEY_TRANSITION] –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É HEIGHT –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        return HEIGHT
    except ValueError:
        logger.warning(f"[SURVEY_AGE_ERROR] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤–≤–µ–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {update.message.text}")
        update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –≤–æ–∑—Ä–∞—Å—Ç\n–≤ –≤–∏–¥–µ —á–∏—Å–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 30):")
        return AGE
    except Exception as e:
        logger.error(f"[SURVEY_AGE_ERROR] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —Å–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç –µ—â–µ —Ä–∞–∑:")
        return AGE

def height(update: Update, context: CallbackContext) -> int:
    try:
        user_height = int(update.message.text)
        user_id = update.effective_user.id
        context.user_data['height'] = user_height
        
        user_message_id = update.message.message_id
        
        session = get_session()
        user = session.query(User).filter(User.user_id == user_id).first()
        if user:
            user.height = user_height
            session.commit()
        session.close()
        
        if 'bot_messages' in context.user_data:
            for msg_id in context.user_data['bot_messages']:
                try:
                    context.bot.delete_message(
                        chat_id=update.message.chat_id,
                        message_id=msg_id
                    )
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞: {e}")
        
        image_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'img', '4_VES.jpg')
        
        try:
            context.bot.delete_message(
                chat_id=update.message.chat_id,
                message_id=user_message_id
            )
        except Exception as e:
            logger.warning(f"[SURVEY_ERROR] –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        
        context.user_data['bot_messages'] = []
        
        try:
            with open(image_path, 'rb') as photo:
                bot_message = context.bot.send_photo(
                    chat_id=user_id,
                    photo=photo,
                    caption="–¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏ —Å–≤–æ–π –≤–µ—Å\n–≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö (–ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —á–∏—Å–ª–æ):"
                )
                
                context.user_data['bot_messages'].append(bot_message.message_id)
        except Exception as e:
            logger.warning(f"[SURVEY_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
            bot_message = context.bot.send_message(
                chat_id=user_id,
                text="–¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏ —Å–≤–æ–π –≤–µ—Å\n–≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö (–ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —á–∏—Å–ª–æ):"
            )
            context.user_data['bot_messages'].append(bot_message.message_id)
        
        return WEIGHT
    except ValueError:
        update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —Ä–æ—Å—Ç\n–≤ –≤–∏–¥–µ —á–∏—Å–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 175):")
        return HEIGHT

def weight(update: Update, context: CallbackContext) -> int:
    try:
        user_weight = int(update.message.text)
        user_id = update.effective_user.id
        context.user_data['weight'] = user_weight
        
        user_message_id = update.message.message_id
        
        session = get_session()
        user = session.query(User).filter(User.user_id == user_id).first()
        if user:
            user.weight = user_weight
            session.commit()
        session.close()
        
        if 'bot_messages' in context.user_data:
            for msg_id in context.user_data['bot_messages']:
                try:
                    context.bot.delete_message(
                        chat_id=update.message.chat_id,
                        message_id=msg_id
                    )
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞: {e}")
        
        context.user_data['selected_goals'] = []
        
        image_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'img', '5_OSNOVNAYA.jpg')
        
        try:
            context.bot.delete_message(
                chat_id=update.message.chat_id,
                message_id=user_message_id
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        
        context.user_data['bot_messages'] = []
        
        try:
            with open(image_path, 'rb') as photo:
                bot_message = context.bot.send_photo(
                    chat_id=user_id,
                    photo=photo,
                    caption="–ö–∞–∫–∞—è —Ç–≤–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å?\n(–≤—ã–±–µ—Ä–∏ —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑ —Å–ø–∏—Å–∫–∞):",
                    reply_markup=main_goal_keyboard()
                )
                context.user_data['bot_messages'].append(bot_message.message_id)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ: {e}")
            bot_message = context.bot.send_message(
                chat_id=user_id,
                text="–ö–∞–∫–∞—è —Ç–≤–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å?\n(–≤—ã–±–µ—Ä–∏ —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑ —Å–ø–∏—Å–∫–∞):",
                reply_markup=main_goal_keyboard()
            )
            context.user_data['bot_messages'].append(bot_message.message_id)
        
        return MAIN_GOAL
    except ValueError:
        update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –≤–µ—Å\n–≤ –≤–∏–¥–µ —á–∏—Å–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 70):")
        return WEIGHT

def main_goal(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    query.answer()
    user_id = update.effective_user.id
    
    goal_dict = {
        'goal_1': '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞',
        'goal_2': '–ù–∞–±–æ—Ä –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã',
        'goal_3': '–ö–æ—Ä—Ä–µ–∫—Ü–∏—è –æ—Å–∞–Ω–∫–∏',
        'goal_4': '–£–±—Ä–∞—Ç—å –∑–∞–∂–∞—Ç–æ—Å—Ç—å –≤ —Ç–µ–ª–µ',
        'goal_5': '–û–±—â–∏–π —Ç–æ–Ω—É—Å/—Ä–µ–ª—å–µ—Ñ –º—ã—à—Ü',
        'goal_6': '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ø–æ—Å–ª–µ —Ä–æ–¥–æ–≤',
        'goal_7': '–°–Ω—è—Ç—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ',
        'goal_8': '–£–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞',
        'goal_9': '–°—Ç–∞—Ç—å –±–æ–ª–µ–µ —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–º'
    }
    
    if query.data == 'goals_done':
        if not context.user_data.get('selected_goals'):
            query.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–µ–ª—å!")
            return MAIN_GOAL
        
        selected_goals_text = ", ".join(context.user_data['selected_goals'])
        context.user_data['main_goal'] = selected_goals_text
        
        session = get_session()
        user = session.query(User).filter(User.user_id == user_id).first()
        if user:
            user.main_goal = selected_goals_text
            session.commit()
        session.close()
        
        try:
            context.bot.delete_message(
                chat_id=query.message.chat_id,
                message_id=query.message.message_id
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        
        if 'bot_messages' not in context.user_data:
            context.user_data['bot_messages'] = []
        
        bot_message = context.bot.send_message(
            chat_id=user_id,
            text=f"–í—ã –≤—ã–±—Ä–∞–ª–∏ —Ü–µ–ª–∏: {selected_goals_text}\n\n–ö–∞–∫–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ü–µ–ª—å?",
            reply_markup=additional_goal_keyboard()
        )
        context.user_data['bot_messages'].append(bot_message.message_id)
        
        return ADDITIONAL_GOAL
    
    goal_key = query.data
    if goal_key in goal_dict:
        goal_name = goal_dict[goal_key]
        
        if 'selected_goals' not in context.user_data:
            context.user_data['selected_goals'] = []
            
        if goal_name not in context.user_data['selected_goals']:
            context.user_data['selected_goals'].append(goal_name)
        else:
            context.user_data['selected_goals'].remove(goal_name)
        
        selected_goals = context.user_data['selected_goals']
        goals_text = "–¢–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ü–µ–ª–∏:\n" + "\n".join([f"‚Ä¢ {goal}" for goal in selected_goals]) if selected_goals else "–¶–µ–ª–∏ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã"
        
        keyboard = []
        for g_key, g_name in goal_dict.items():
            prefix = "‚úÖ" if g_name in selected_goals else "‚òëÔ∏è"
            keyboard.append([InlineKeyboardButton(f"{prefix} {g_name}", callback_data=g_key)])
        
        keyboard.append([InlineKeyboardButton("–ì–æ—Ç–æ–≤–æ ‚úì", callback_data="goals_done")])
        
        try:
            current_caption = query.message.caption or ""
            
            context.bot.edit_message_caption(
                chat_id=query.message.chat_id,
                message_id=query.message.message_id,
                caption=f"{goals_text}\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–∏ —Ü–µ–ª–∏\n(–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
            
            logger.info(f"–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º —Ü–µ–ª–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤—ã–±–æ—Ä–æ–º —Ü–µ–ª–µ–π: {e}")
        
        return MAIN_GOAL
    
    return MAIN_GOAL

def additional_goal(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    query.answer()
    
    user_id = update.effective_user.id
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ü–µ–ª–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}, –≤—ã–±–æ—Ä: {query.data}")
    
    goal_dict = {
        'add_goal_1': '–ü–æ—Å–ª—É—à–∞—Ç—å –ª–µ–∫—Ü–∏–∏ –æ—Ç –≤—Ä–∞—á–µ–π, —Ç—Ä–µ–Ω–µ—Ä–æ–≤',
        'add_goal_2': '–ü–æ—Å–ª—É—à–∞—Ç—å –ª–µ–∫—Ü–∏–∏ –æ—Ç –ø—Ä–æ—Ñ –ø—Å–∏—Ö–æ–ª–æ–≥–æ–≤',
        'add_goal_3': '–ë–æ–ª—å—à–µ —É–∑–Ω–∞—Ç—å –æ –∑–¥–æ—Ä–æ–≤–æ–º –ø–∏—Ç–∞–Ω–∏–∏',
        'add_goal_4': '–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–≤–æ—é –∂–∏–∑–Ω—å –º–µ–¥–∏—Ç–∞—Ü–∏–∏, –ø—Ä–∞–∫—Ç–∏–∫–∏',
        'add_goal_5': '–û–±—Ä–µ—Å—Ç–∏ –Ω–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞',
        'add_goal_6': '–ü–æ–¥–¥–µ—Ä–∂–∫–∞, –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å, –º–æ—Ç–∏–≤–∞—Ü–∏—è'
    }
    
    if query.data == 'additional_goals_done':
        if not context.user_data.get('selected_additional_goals'):
            query.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Ü–µ–ª—å!")
            return ADDITIONAL_GOAL
        
        selected_goals_text = ", ".join(context.user_data['selected_additional_goals'])
        context.user_data['additional_goal'] = selected_goals_text
        
        session = get_session()
        user = session.query(User).filter(User.user_id == user_id).first()
        if user:
            user.additional_goal = selected_goals_text
            session.commit()
        session.close()
        
        try:
            context.bot.delete_message(
                chat_id=query.message.chat_id,
                message_id=query.message.message_id
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        
        if 'bot_messages' not in context.user_data:
            context.user_data['bot_messages'] = []
        
        image_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'img', '7_FORMAT.jpg')
        
        try:
            with open(image_path, 'rb') as photo:
                bot_message = context.bot.send_photo(
                    chat_id=user_id,
                    photo=photo,
                    caption=f"–í—ã –≤—ã–±—Ä–∞–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–µ–ª–∏: {selected_goals_text}\n\n–ö–∞–∫–æ–π —É –≤–∞—Å —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã?",
                    reply_markup=work_format_keyboard()
                )
                context.user_data['bot_messages'].append(bot_message.message_id)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ: {e}")
            bot_message = context.bot.send_message(
                chat_id=user_id,
                text=f"–í—ã –≤—ã–±—Ä–∞–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–µ–ª–∏: {selected_goals_text}\n\n–ö–∞–∫–æ–π —É –≤–∞—Å —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã?",
                reply_markup=work_format_keyboard()
            )
            context.user_data['bot_messages'].append(bot_message.message_id)
        
        return WORK_FORMAT
    
    goal_key = query.data
    if goal_key in goal_dict:
        goal_name = goal_dict[goal_key]
        logger.info(f"–í—ã–±—Ä–∞–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ü–µ–ª—å: {goal_name}")
        
        if 'selected_additional_goals' not in context.user_data:
            context.user_data['selected_additional_goals'] = []
            
        if goal_name not in context.user_data['selected_additional_goals']:
            context.user_data['selected_additional_goals'].append(goal_name)
        else:
            context.user_data['selected_additional_goals'].remove(goal_name)
        
        selected_goals = context.user_data['selected_additional_goals']
        goals_text = "–¢–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–µ–ª–∏:\n" + "\n".join([f"‚Ä¢ {goal}" for goal in selected_goals]) if selected_goals else "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–µ–ª–∏ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã"
        
        keyboard = []
        for g_key, g_name in goal_dict.items():
            prefix = "‚úÖ" if g_name in selected_goals else "‚òëÔ∏è"
            keyboard.append([InlineKeyboardButton(f"{prefix} {g_name}", callback_data=g_key)])
        
        keyboard.append([InlineKeyboardButton("–ì–æ—Ç–æ–≤–æ ‚úì", callback_data="additional_goals_done")])
        
        try:
            context.bot.edit_message_text(
                chat_id=query.message.chat_id,
                message_id=query.message.message_id,
                text=f"{goals_text}\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–µ–ª–∏\n(–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
            
            logger.info(f"–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤—ã–±–æ—Ä–æ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π: {e}")
        
        return ADDITIONAL_GOAL
    
    logger.warning(f"–ü–æ–ª—É—á–µ–Ω –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π callback_data –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ü–µ–ª–∏: {query.data}")
    return ADDITIONAL_GOAL

def work_format(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    query.answer()
    
    user_id = update.effective_user.id
    user_work_format = query.data
    context.user_data['work_format'] = user_work_format
    
    session = get_session()
    user = session.query(User).filter(User.user_id == user_id).first()
    if user:
        user.work_format = user_work_format
        session.commit()
    session.close()
    
    if 'bot_messages' in context.user_data:
        for msg_id in context.user_data['bot_messages']:
            try:
                context.bot.delete_message(
                    chat_id=query.message.chat_id,
                    message_id=msg_id
                )
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞: {e}")
    
    image_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'img', '8_SKOLKO.jpg')
    
    try:
        context.bot.delete_message(
            chat_id=query.message.chat_id,
            message_id=query.message.message_id
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
    
    context.user_data['bot_messages'] = []
    
    try:
        with open(image_path, 'rb') as photo:
            bot_message = context.bot.send_photo(
                chat_id=user_id,
                photo=photo,
                caption="–ö–∞–∫ —á–∞—Å—Ç–æ –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è —Å–ø–æ—Ä—Ç–æ–º?",
                reply_markup=sport_frequency_keyboard()
            )
            context.user_data['bot_messages'].append(bot_message.message_id)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ: {e}")
        bot_message = context.bot.send_message(
            chat_id=user_id,
            text="–ö–∞–∫ —á–∞—Å—Ç–æ –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è —Å–ø–æ—Ä—Ç–æ–º?",
            reply_markup=sport_frequency_keyboard()
        )
        context.user_data['bot_messages'].append(bot_message.message_id)
    
    return SPORT_FREQUENCY

def sport_frequency(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    query.answer()
    
    user_id = update.effective_user.id
    user_sport_frequency = query.data
    context.user_data['sport_frequency'] = user_sport_frequency
    
    session = get_session()
    user = session.query(User).filter(User.user_id == user_id).first()
    if user:
        user.sport_frequency = user_sport_frequency
        user.registered = True  # –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        session.commit()
    session.close()
    
    is_subscribed, paid_till = check_subscription_status(user_id)
    
    if 'bot_messages' in context.user_data:
        for msg_id in context.user_data['bot_messages']:
            try:
                context.bot.delete_message(
                    chat_id=query.message.chat_id,
                    message_id=msg_id
                )
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞: {e}")
    
    try:
        context.bot.delete_message(
            chat_id=query.message.chat_id,
            message_id=query.message.message_id
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
    
    context.user_data['bot_messages'] = []
    
    image_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'img', 'SPASIBO_ZA_OTVETI.png')
    
    if is_subscribed:
        try:
            with open(image_path, 'rb') as photo:
                bot_message = context.bot.send_photo(
                    chat_id=user_id,
                    photo=photo,
                    caption="–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! üëç\n\n"
                            "–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞. –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å—É –æ—Ç–∫—Ä—ã—Ç!"
                )
                context.user_data['bot_messages'].append(bot_message.message_id)
            context.bot.send_message(
                chat_id=user_id,
                text="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
                reply_markup=get_main_keyboard()
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ: {e}")
            bot_message = context.bot.send_message(
                chat_id=user_id,
                text="–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! üëç\n\n"
                    "–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞. –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å—É –æ—Ç–∫—Ä—ã—Ç!",
                reply_markup=get_main_keyboard()
            )
            context.user_data['bot_messages'].append(bot_message.message_id)
    else:
        selected_goals = context.user_data.get('selected_goals', [])
        goals_text = ", ".join(selected_goals).lower() if selected_goals else "–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ç–≤–æ–∏—Ö —Ü–µ–ª–µ–π"
        
        try:
            with open(image_path, 'rb') as photo:
                bot_message = context.bot.send_photo(
                    chat_id=user_id,
                    photo=photo,
                    caption=(f"–°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã! –î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Ç—ã —Å–º–æ–≥ –ø—Ä–∏–π—Ç–∏ –∫ —Å–≤–æ–µ–π —Ü–µ–ª–∏:\n" +
                            (f"- " + "\n- ".join(selected_goals) + "\n\n" if selected_goals else "") +
                            f"–î–ª—è —Ç–µ–±—è –≥–æ—Ç–æ–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏\n\n"
                            f"*–¢–∞–∫ –∂–µ health-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ–¥–±–µ—Ä–µ—Ç –¥–ª—è —Ç–µ–±—è:* \n\n"
                            f"- –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–∏—Ç–∞–Ω–∏—è\n"
                            f"- –°–¥–µ–ª–∞–µ—Ç —Ä–∞–∑–±–æ—Ä –∞–Ω–∞–ª–∏–∑–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤ –≤ –æ—Ä–≥–∞–Ω–∏–∑–º–µ,\n"
                            f"—á—Ç–æ–±—ã —Ç—ã —Å–º–æ–≥ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ –ø–æ–¥–æ–π—Ç–∏ –∫ —Å–≤–æ–µ–º—É –∑–¥–æ—Ä–æ–≤—å—é"),
                    reply_markup=get_payment_keyboard(user_id, context),
                    parse_mode=ParseMode.MARKDOWN
                )
                context.user_data['bot_messages'].append(bot_message.message_id)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ: {e}")
            bot_message = context.bot.send_message(
                chat_id=user_id,
                text=(f"–°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã! –î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Ç—ã —Å–º–æ–≥ –ø—Ä–∏–π—Ç–∏ –∫ —Å–≤–æ–µ–π —Ü–µ–ª–∏:\n" +
                    (f"- " + "\n- ".join(selected_goals) + "\n\n" if selected_goals else "") +
                    f"–î–ª—è —Ç–µ–±—è –≥–æ—Ç–æ–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏\n\n"
                    f"*–¢–∞–∫ –∂–µ health-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ–¥–±–µ—Ä–µ—Ç –¥–ª—è —Ç–µ–±—è:* \n\n"
                     f"- –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–∏—Ç–∞–Ω–∏—è\n"
                     f"- –°–¥–µ–ª–∞–µ—Ç —Ä–∞–∑–±–æ—Ä –∞–Ω–∞–ª–∏–∑–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤ –≤ –æ—Ä–≥–∞–Ω–∏–∑–º–µ,\n"
                    f"—á—Ç–æ–±—ã —Ç—ã —Å–º–æ–≥ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ –ø–æ–¥–æ–π—Ç–∏ –∫ —Å–≤–æ–µ–º—É –∑–¥–æ—Ä–æ–≤—å—é"),
                reply_markup=get_payment_keyboard(user_id, context),
                parse_mode=ParseMode.MARKDOWN
            )
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
            context.user_data['bot_messages'].append(bot_message.message_id)
    
    return ConversationHandler.END


def payment(update: Update, context: CallbackContext) -> int:
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏
    """
    user_id = update.effective_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –∏–∑ –º–æ–¥—É–ª—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å–æ–º–Ω–µ–Ω–∏–π
    from bot.subscription_doubt_handler import get_subscription_keyboard
    
    update.message.reply_text(
        "–í–∞—Ä–∏–∞–Ω—Ç—ã WILLWAY –ø–æ–¥–ø–∏—Å–∫–∏:",
        reply_markup=get_subscription_keyboard()
    )
    return ConversationHandler.END

def handle_menu_callback(update: Update, context: CallbackContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∏–Ω–ª–∞–π–Ω –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
    """
    query = update.callback_query
    query.answer()
    
    user_id = update.effective_user.id
    callback_data = query.data
    
    logger.info(f"[CALLBACK] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞–∂–∞–ª –Ω–∞ –∫–Ω–æ–ø–∫—É: {callback_data}")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π, —Ç—Ä–µ–±—É—é—â–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
    if callback_data == "health_assistant":
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
        is_subscribed = update_subscription_status(user_id, context)
        
        if not is_subscribed:
            query.edit_message_text(
                "–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.",
                reply_markup=get_payment_keyboard_inline(user_id)
            )
            return
        
        # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        query.edit_message_text(
            "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –∏ –º–µ–Ω—Ç–∞–ª—å–Ω–æ–º –∑–¥–æ—Ä–æ–≤—å–µ. "
            "–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Ç–µ–±–µ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö, –ø–∏—Ç–∞–Ω–∏–∏ –∏ –æ–±—â–µ–º –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–∏. "
            "–ü—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç.\n\n"
            "–ß—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É '–ù–∞–∑–∞–¥'.",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]])
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
        context.bot.send_message(
            chat_id=user_id,
            text="–ó–∞–¥–∞–π –º–Ω–µ –≤–æ–ø—Ä–æ—Å –æ –∑–¥–æ—Ä–æ–≤—å–µ, –ø–∏—Ç–∞–Ω–∏–∏ –∏–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö:",
            reply_markup=ReplyKeyboardMarkup([["–ù–∞–∑–∞–¥"]], resize_keyboard=True)
        )
        
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π"
    elif callback_data == "subscription_management":
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            session = get_session()
            user = session.query(User).filter(User.user_id == user_id).first()
            
            if user:
                is_subscribed = user.is_subscribed
                subscription_type = user.subscription_type
                subscription_expires = user.subscription_expires
                
                if is_subscribed and subscription_expires:
                    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
                    expires_date = subscription_expires.strftime("%d.%m.%Y")
                    remaining_days = (subscription_expires - datetime.now()).days
                    
                    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    sub_type = "–º–µ—Å—è—á–Ω–∞—è" if subscription_type == "monthly" else "–≥–æ–¥–æ–≤–∞—è"
                    
                    # –ü–æ–ª—É—á–∞–µ–º username –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                    config = get_bot_config()
                    manager_username = config.get("manager_username", "willway_manager")
                    
                    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–æ–π
                    keyboard = [
                        [InlineKeyboardButton("–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data="renew_subscription")],
                        [get_cancel_subscription_button()],
                        [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]
                    ]
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∫–µ
                    query.edit_message_text(
                        f"üíé *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ*\n\n"
                        f"‚Ä¢ –¢–∏–ø: {sub_type}\n"
                        f"‚Ä¢ –ê–∫—Ç–∏–≤–Ω–∞ –¥–æ: {expires_date}\n"
                        f"‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: {remaining_days}\n\n"
                        f"–î–ª—è –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞–∂–º–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
                        parse_mode=ParseMode.MARKDOWN,
                        reply_markup=InlineKeyboardMarkup(keyboard)
                    )
                else:
                    # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
                    query.edit_message_text(
                        "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏.\n\n"
                        "–û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É –∏ –¥—Ä—É–≥–∏–º —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞:",
                        reply_markup=get_payment_keyboard_inline(user_id)
                    )
            else:
                # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                query.edit_message_text(
                    "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å–∫–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]])
                )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∫–µ: {e}")
            query.edit_message_text(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∫–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]])
            )
        finally:
            if 'session' in locals() and session:
                session.close()
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π"
    elif callback_data == "support":
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–≤—è–∑–∏ —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –∏ —Ç—Ä–µ–Ω–µ—Ä–æ–º
        query.edit_message_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ —Å –∫–µ–º —Ö–æ—Ç–∏—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è:",
            reply_markup=support_keyboard()
        )
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞" (–∑–∞–≥–ª—É—à–∫–∞)
    elif callback_data == "invite_friend":
        # –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        session = get_session()
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
            ref_code = session.query(ReferralCode).filter(
                ReferralCode.user_id == user_id, 
                ReferralCode.is_active == True
            ).first()
            
            if not ref_code:
                # –ï—Å–ª–∏ –∫–æ–¥–∞ –Ω–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π
                import random
                import string
                new_code = ''.join(random.choices(string.ascii_uppercase + string.digits, k=8))
                
                ref_code = ReferralCode(
                    user_id=user_id,
                    code=new_code,
                    is_active=True
                )
                session.add(ref_code)
                session.commit()
                
                code = new_code
                logger.info(f"[REFERRAL] –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ {code} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            else:
                code = ref_code.code
                logger.info(f"[REFERRAL] –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ {code} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π
            total_invited = session.query(ReferralUse).filter(
                ReferralUse.referrer_id == user_id
            ).count()
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä—É–∑–µ–π, –æ–ø–ª–∞—Ç–∏–≤—à–∏—Ö –ø–æ–¥–ø–∏—Å–∫—É
            paid_friends = session.query(ReferralUse).filter(
                ReferralUse.referrer_id == user_id,
                ReferralUse.subscription_purchased == True
            ).count()
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –±–æ—Ç–∞
            bot_username = os.environ.get('TELEGRAM_BOT_USERNAME', 'willwayapp_bot')  # –ü–æ–ª—É—á–∞–µ–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
            try:
                bot_info = context.bot.get_me()
                bot_username = bot_info.username
            except:
                logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å username –±–æ—Ç–∞")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
            referral_link = f"https://t.me/{bot_username}?start={code}"
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —ç–º–æ–¥–∑–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
            message = (
                "–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã!\n\n"
                "–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –æ—Ñ–æ—Ä–º–∏—Ç –ø–æ–¥–ø–∏—Å–∫—É, "
                "–≤—ã –ø–æ–ª—É—á–∏—Ç–µ +1 –º–µ—Å—è—Ü –∫ –≤–∞—à–µ–π —Ç–µ–∫—É—â–µ–π –ø–æ–¥–ø–∏—Å–∫–µ.\n\n"
                "–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
                f"- –í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π: {total_invited}\n"
                f"- –î—Ä—É–∑–µ–π —Å –ø–æ–¥–ø–∏—Å–∫–æ–π: {paid_friends}\n"
                f"- –ë–æ–Ω—É—Å–Ω—ã—Ö –º–µ—Å—è—Ü–µ–≤ –ø–æ–ª—É—á–µ–Ω–æ: {paid_friends}\n\n"
                f"–í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: {code}\n"
            )
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            keyboard = InlineKeyboardMarkup([
                [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]
            ])
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            context.bot.send_message(
                chat_id=user_id,
                text=message,
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=keyboard
            )
            
        except Exception as e:
            logger.error(f"[REFERRAL_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥—Ä—É–≥–∞: {str(e)}")
            context.bot.send_message(
                chat_id=user_id,
                text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≤–∞—à–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )
        finally:
            session.close()
        return
        
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
    elif callback_data.startswith("copy_ref_link_"):
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ callback_data
        ref_code = callback_data.replace("copy_ref_link_", "")
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –±–æ—Ç–∞
            bot_username = os.environ.get('TELEGRAM_BOT_USERNAME', 'willwayapp_bot')  # –ü–æ–ª—É—á–∞–µ–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
            try:
                bot_info = context.bot.get_me()
                bot_username = bot_info.username
            except:
                logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å username –±–æ—Ç–∞")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
            referral_link = f"https://t.me/{bot_username}?start={ref_code}"
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –µ–µ
            context.bot.send_message(
                chat_id=user_id,
                text=f"–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n{referral_link}",
                reply_markup=InlineKeyboardMarkup([[
                    InlineKeyboardButton("–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ", callback_data="invite_friend")
                ]])
            )
            
            # –î–∞–µ–º –∑–Ω–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ —Å—Å—ã–ª–∫–∞ –±—ã–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞
            query.answer("–°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏!")
        except Exception as e:
            logger.error(f"[REFERRAL_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏: {str(e)}")
        query.edit_message_text(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Å—ã–ª–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="invite_friend")]])
        )
        return
        
    elif callback_data == "referral_stats":
        session = get_session()
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            referrals = session.query(ReferralUse, User).join(
                User, ReferralUse.referred_id == User.user_id
            ).filter(
                ReferralUse.referrer_id == user_id
            ).all()
            
            if not referrals:
                query.edit_message_text(
                    "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–∑—å—è–º–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –±–æ–Ω—É—Å—ã!",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="invite_friend")]])
                )
                return
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
            message = "üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∞—à–∏—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:*\n\n"
            
            for i, (ref_use, user) in enumerate(referrals, 1):
                username = user.username or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
                status = "‚úÖ –û—Ñ–æ—Ä–º–∏–ª –ø–æ–¥–ø–∏—Å–∫—É" if ref_use.subscription_purchased else "‚ùå –ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏"
                date = ref_use.used_at.strftime("%d.%m.%Y")
                
                message += f"{i}. *{username}* - {status}\n"
                message += f"   –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {date}\n"
                
                if ref_use.subscription_purchased:
                    purchase_date = ref_use.purchase_date.strftime("%d.%m.%Y") if ref_use.purchase_date else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
                    message += f"   –î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã: {purchase_date}\n"
                
                message += "\n"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            total_invited = len(referrals)
            paid_friends = sum(1 for ref, _ in referrals if ref.subscription_purchased)
            
            message += f"*–í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ:* {total_invited}\n"
            message += f"*–° –ø–æ–¥–ø–∏—Å–∫–æ–π:* {paid_friends}\n"
            message += f"*–ë–æ–Ω—É—Å–Ω—ã—Ö –º–µ—Å—è—Ü–µ–≤ –ø–æ–ª—É—á–µ–Ω–æ:* {paid_friends}"
            
            query.edit_message_text(
                message,
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="invite_friend")]])
            )
        except Exception as e:
            logger.error(f"[REFERRAL_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: {str(e)}")
            query.edit_message_text(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="invite_friend")]])
            )
        finally:
            session.close()
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"
    elif callback_data == "back_to_menu":
        query.edit_message_text(
            "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é WILLWAY:",
            reply_markup=InlineKeyboardMarkup(menu_keyboard())
        )
        return
        
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –æ–ø–ª–∞—Ç—ã
    elif callback_data == "payment_monthly" or callback_data == "payment_yearly":
        subscription_type = "monthly" if callback_data == "payment_monthly" else "yearly"
        logger.info(f"[PAYMENT_SELECTED] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤—ã–±—Ä–∞–ª {subscription_type} –ø–æ–¥–ø–∏—Å–∫—É")
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
        session = get_session()
        user = session.query(User).filter(User.user_id == user_id).first()
        session.close()
        
        # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞
        user_data = {
            'user_id': user_id,
            'email': user.email if user and user.email else None,
            'phone': user.phone if user and user.phone else None,
            'username': update.effective_user.username
        }
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π
        payment_handler = PaymentHandler()
        
        # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É –Ω–∞ Tilda
        payment_url = payment_handler.generate_tilda_payment_link(user_data, subscription_type)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞
        if payment_url:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –æ–ø–ª–∞—Ç—É
            query.edit_message_text(
                text=f"–î–ª—è –æ–ø–ª–∞—Ç—ã {'–º–µ—Å—è—á–Ω–æ–π' if subscription_type == 'monthly' else '–≥–æ–¥–æ–≤–æ–π'} –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ", url=payment_url)],
                    [InlineKeyboardButton("–û—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel_payment")]
                ])
            )
            
            # –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É
            logger.info(f"[PAYMENT_LINK_CREATED] –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å–æ–∑–¥–∞–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É: {payment_url}")
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –æ–ø–ª–∞—Ç–µ
            schedule_payment_reminder(context, user_id, delay_minutes=30)
        else:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            query.edit_message_text(
                text="–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é", callback_data="back_to_menu")]
                ])
            )
            logger.error(f"[PAYMENT_ERROR] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} (—Ç–∏–ø: {subscription_type})")
        
        return
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–ª–∞—Ç–µ–∂–∞
    elif callback_data == "cancel_payment":
        logger.info(f"[PAYMENT_CANCELLED] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ—Ç–º–µ–Ω–∏–ª –ø–ª–∞—Ç–µ–∂")
        
        # –û—Ç–º–µ–Ω—è–µ–º –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–ª–∞—Ç–µ–∂–µ
        cancel_payment_reminder(context, user_id)
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        query.edit_message_text(
            text="–û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é", callback_data="back_to_menu")]
            ])
        )
        
        return
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
    elif callback_data == "renew_subscription":
        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –ø–ª–∞—Ç–µ–∂–µ
        session = get_session()
        user = session.query(User).filter(User.user_id == user_id).first()
        
        if user and user.subscription_type:
            subscription_type = user.subscription_type
            session.close()
            
            # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏
            payment_url = generate_payment_url(user_id, subscription_type)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞
            if payment_url:
                keyboard = [[InlineKeyboardButton("–û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)],
                            [InlineKeyboardButton("–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é", callback_data="back_to_menu")]]
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –ø–µ—Ä–∏–æ–¥ –ø–æ–¥–ø–∏—Å–∫–∏
                if subscription_type == "monthly":
                    amount = f"{MONTHLY_SUBSCRIPTION_PRICE:,}".replace(",", " ") + " ‚ÇΩ"
                    period = "30 –¥–Ω–µ–π"
                else:  # yearly
                    amount = f"{YEARLY_SUBSCRIPTION_PRICE:,}".replace(",", " ") + " ‚ÇΩ"
                    period = "365 –¥–Ω–µ–π"
                
                query.edit_message_text(
                    text=(
                        f"üíé *–ü—Ä–æ–¥–ª–µ–Ω–∏–µ {subscription_type} –ø–æ–¥–ø–∏—Å–∫–∏ WILLWAY*\n\n"
                        f"‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: {amount}\n"
                        f"‚Ä¢ –ü–µ—Ä–∏–æ–¥: {period}\n\n"
                        f"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É."
                    ),
                    parse_mode=ParseMode.MARKDOWN,
                    reply_markup=InlineKeyboardMarkup(keyboard)
                )
            else:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É
                query.edit_message_text(
                    text="–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton("–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é", callback_data="back_to_menu")]
                    ])
                )
                logger.error(f"[PAYMENT_ERROR] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} (—Ç–∏–ø: {subscription_type})")
        else:
            if session:
                session.close()
            
            # –ï—Å–ª–∏ —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—ã–±—Ä–∞—Ç—å
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—ã —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á –∏ —Å–∏–º–≤–æ–ª–æ–º —Ä—É–±–ª—è
            monthly_price = f"{MONTHLY_SUBSCRIPTION_PRICE:,}".replace(",", " ") + " ‚ÇΩ"
            yearly_price = f"{YEARLY_SUBSCRIPTION_PRICE:,}".replace(",", " ") + " ‚ÇΩ"
            
            # –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —ç–∫–æ–Ω–æ–º–∏–∏ –ø—Ä–∏ –≥–æ–¥–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–µ
            monthly_yearly = MONTHLY_SUBSCRIPTION_PRICE * 12
            savings_percent = round((monthly_yearly - YEARLY_SUBSCRIPTION_PRICE) / monthly_yearly * 100)
            
            query.edit_message_text(
                text=(
                    "üíé *–ü–æ–¥–ø–∏—Å–∫–∞ WILLWAY*\n\n"
                    "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞–º —Ç–∞—Ä–∏—Ñ:\n\n"
                    f"‚Ä¢ *–ú–µ—Å—è—Ü* - {monthly_price}\n"
                    f"‚Ä¢ *–ì–æ–¥* - {yearly_price} (—ç–∫–æ–Ω–æ–º–∏—è {savings_percent}%)\n\n"
                    "–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞."
                ),
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=payment_keyboard()
            )
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏ –∏–∑ –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è
    elif callback_data == "subscription_30days":
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –º–µ—Å—è—á–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
        logger.info(f"[PAYMENT_SELECTED] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤—ã–±—Ä–∞–ª –º–µ—Å—è—á–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É (30 –¥–Ω–µ–π)")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º URL –æ–ø–ª–∞—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–∏–º
        payment_url = generate_payment_url(user_id, "monthly")
        if payment_url:
            keyboard = [[InlineKeyboardButton("–û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)]]
            query.edit_message_text(
                text="–û—Ç–ª–∏—á–Ω–æ! –í—ã –≤—ã–±—Ä–∞–ª–∏ –º–µ—Å—è—á–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É (30 –¥–Ω–µ–π) –∑–∞ 1.555 —Ä—É–±.\n\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ.",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
        else:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            query.edit_message_text(
                text="–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é", callback_data="back_to_menu")]
                ])
            )
        return
    
    elif callback_data == "subscription_1year":
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥–æ–¥–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
        logger.info(f"[PAYMENT_SELECTED] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤—ã–±—Ä–∞–ª –≥–æ–¥–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º URL –æ–ø–ª–∞—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–∏–º
        payment_url = generate_payment_url(user_id, "yearly")
        if payment_url:
            keyboard = [[InlineKeyboardButton("–û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)]]
            query.edit_message_text(
                text="–û—Ç–ª–∏—á–Ω–æ! –í—ã –≤—ã–±—Ä–∞–ª–∏ –≥–æ–¥–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É –∑–∞ 13.333 —Ä—É–±. —Å–æ —Å–∫–∏–¥–∫–æ–π 30% –∏ –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ç—Ä–µ–Ω–µ—Ä—É.\n\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ.",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
        else:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            query.edit_message_text(
                text="–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é", callback_data="back_to_menu")]
                ])
            )
        return
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –∑–∞–ø—É—Å–∫–∞ –æ–ø—Ä–æ—Å–∞
    elif callback_data == "start_survey":
        return start_survey(update, context)

    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–Ω–æ–ø–æ–∫ –∑–¥–µ—Å—å

def generate_payment_url(user_id, subscription_type):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç URL –¥–ª—è –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏"""
    logger.info(f"[PAYMENT] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è URL –æ–ø–ª–∞—Ç—ã (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}, —Ç–∏–ø {subscription_type})")
    # –§–æ—Ä–º–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–π URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–ø–ª–∞—Ç—ã
    payment_url = "https://willway.pro/payment"
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    full_url = f"{payment_url}?tgid={user_id}"
    logger.info(f"[PAYMENT] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω URL: {full_url}")
    return full_url

def handle_payment_success(update: Update, context: CallbackContext, query=None) -> int:
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã (—Å–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω–∞)"""
    user_id = update.effective_user.id if update else query.from_user.id
    logger.info(f"[PAYMENT_DISABLED] –ü–æ–ø—ã—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})")
    return ConversationHandler.END

def send_successful_payment_messages(update: Update, context: CallbackContext, subscription_status):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ"""
    user_id = update.effective_user.id
    
    message = (
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –¥–æ–≤–µ—Ä–∏–µ. –¢—ã —Å–¥–µ–ª–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä! "
        "–ú—ã –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è —Å–¥–µ–ª–∞—Ç—å –≤—Å–µ, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ –ø—Ä–∏–π—Ç–∏ –∫ —Å–≤–æ–µ–π —Ü–µ–ª–∏.\n\n"
        "–î–∞–≤–∞–π –≤–≤–µ–¥—É —Ç–µ–±—è —Å—Ä–∞–∑—É –≤ –∫—É—Ä—Å –¥–µ–ª–∞.\n\n"
        "–ü–æ –∫–Ω–æ–ø–∫–∞–º –≤–Ω–∏–∑—É —Ç—ã –º–æ–∂–µ—à—å:\n"
        "- –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∏ –ª–∏—á–Ω–æ–º—É –∫–∞–±–∏–Ω–µ—Ç—É, –≥–¥–µ —Ç–µ–±—è –∂–¥—É—Ç —Ç–≤–æ–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã,\n\n"
        "- –¥–æ–±–∞–≤–∏—Ç—å—Å—è –≤ –∫–∞–Ω–∞–ª —Å –∞–Ω–æ–Ω—Å–∞–º–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π, –ø—Ä—è–º—ã—Ö —ç—Ñ–∏—Ä–æ–≤ –∏ –ø—Ä–æ—Å—Ç–æ "
        "–ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –∏ –º–µ–Ω—Ç–∞–ª—å–Ω–æ–º –∑–¥–æ—Ä–æ–≤—å–µ\n\n"
        "–ü–æ –∫–Ω–æ–ø–∫–µ menu —Ç—ã –º–æ–∂–µ—à—å:\n"
        "- –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å Health-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º, –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–∏—Ç–∞–Ω–∏—è, —Å–¥–µ–ª–∞—Ç—å —Ä–∞–∑–±–æ—Ä –∞–Ω–∞–ª–∏–∑–æ–≤\n"
        "- —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π,\n"
        "- —Å–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π, –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–Ω–µ—Ä—É/–Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥—É/–ø—Å–∏—Ö–æ–ª–æ–≥—É\n"
        "- –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤ –Ω–∞—à —Å–µ—Ä–≤–∏—Å –¥—Ä—É–≥–∞ –∏ –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å—ã, –∫–æ—Ç–æ—Ä—ã–º–∏ –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å "
        "–ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ –≤—ã–≤–µ—Å—Ç–∏ —Å–µ–±–µ –Ω–∞ —Å—á–µ—Ç."
    )
    
    # –ü–æ–ª—É—á–∞–µ–º URL –∫–∞–Ω–∞–ª–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    config = get_bot_config()
    channel_url = config.get("channel_url", "https://t.me/willway_channel")
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –∏ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∫–∞–Ω–∞–ª
    keyboard = [
        [InlineKeyboardButton("–î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é", web_app={"url": "https://willway.pro/app"})],
        [InlineKeyboardButton("–í—Å—Ç—É–ø–∏—Ç—å –≤ –∫–∞–Ω–∞–ª", url=channel_url)]
    ]
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
    context.bot.send_message(
        chat_id=user_id,
        text=message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

def send_pending_message(user_id, manager_username):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –æ–ø–ª–∞—Ç–µ"""
    # –¢–µ–∫—Å—Ç –∏–∑ —Å–∫—Ä–∏–Ω–∞ 3
    message = (
        "–ú—ã –≤–∏–¥–∏–º, —á—Ç–æ —Ç—ã –Ω–∞—á–∞–ª(–∞) –ø—Ä–æ—Ü–µ—Å—Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª –æ–ø–ª–∞—Ç—É.\n\n"
        "–ï—Å–ª–∏ —É —Ç–µ–±—è –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –æ–ø–ª–∞—Ç–æ–π, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ –∑–¥–µ—Å—å "
        "–∏ —è —Å —Ä–∞–¥–æ—Å—Ç—å—é –ø–æ–º–æ–≥—É —Ç–µ–±–µ"
    )
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
    keyboard = [
        [InlineKeyboardButton("–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É", url=f"https://t.me/{manager_username}")],
        [InlineKeyboardButton("–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏", url=f"https://willway.pro/payment?tgid={user_id}")]
    ]
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º Bot –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    bot = Bot(token=os.getenv("TELEGRAM_TOKEN"))
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
    bot.send_message(
        chat_id=user_id,
        text=message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

def send_payment_processing_messages(update: Update, context: CallbackContext):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞ (—Å–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω–∞)"""
    user_id = update.effective_user.id
    logger.info(f"[PAYMENT_DISABLED] –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})")
    return

def check_payment_status_job(context: CallbackContext):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ (—Å–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω–∞)"""
    logger.info("[PAYMENT_DISABLED] –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞")
    return

def webhook_handler(update: Update, context: CallbackContext):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook (—Å–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω–∞)"""
    logger.info("[PAYMENT_DISABLED] –ü–æ–ª—É—á–µ–Ω webhook (—Å–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω–∞)")
    return

def create_payment_record(user_id, subscription_type, payment_amount, payment_status='pending'):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –æ –ø–ª–∞—Ç–µ–∂–µ (—Å–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω–∞)"""
    logger.info(f"[PAYMENT_DISABLED] –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –æ –ø–ª–∞—Ç–µ–∂–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}, —Ç–∏–ø {subscription_type})")
    return False

def handle_support_messages(update, context):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–Ω–æ–ø–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∏."""
    text = update.message.text
    user_id = update.effective_user.id
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤ –º–µ–Ω—é –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤—ã–±—Ä–∞–ª: {text}")

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞–ø—Ä—è–º—É—é
    keyboard = [
        [KeyboardButton("Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç")],
        [KeyboardButton("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π")],
        [KeyboardButton("–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π")],
        [KeyboardButton("–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞")]
    ]
    
    main_kb = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

    if text == "–°–≤—è–∑–∞—Ç—å—Å—è —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º":
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—Ä–µ–Ω–µ—Ä–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        config = get_bot_config()
        trainer_username = config.get('trainer_username', '')
        
        if trainer_username:
            update.message.reply_text(
                f"–í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º —á–µ—Ä–µ–∑ Telegram: @{trainer_username}",
                reply_markup=main_kb
            )
        else:
            update.message.reply_text(
                "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=main_kb
            )
    
    elif text == "–°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º":
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        config = get_bot_config()
        manager_username = config.get('manager_username', '')
        
        if manager_username:
            update.message.reply_text(
                f"–í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º —á–µ—Ä–µ–∑ Telegram: @{manager_username}",
                reply_markup=main_kb
            )
        else:
            update.message.reply_text(
                "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=main_kb
            )
    
    elif text == "–ú–µ–Ω—é ‚úÖ":
        update.message.reply_text(
            "–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", 
            reply_markup=main_kb
        )

def handle_other_messages(update, context):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –¥—Ä—É–≥–∏–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏."""
    user_id = update.effective_user.id
    text = update.message.text
    logger.info(f"[OTHER_MESSAGE] –ü–æ–ª—É—á–µ–Ω–æ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {text}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞–∂–∞—Ç–∏–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É "–ü–æ–¥–æ–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É"
    if text == "–ü–æ–¥–æ–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É":
        logger.info(f"[SURVEY_START] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞–∂–∞–ª –Ω–∞ –∫–Ω–æ–ø–∫—É '–ü–æ–¥–æ–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É'")
        return start_survey(update, context)
    
    # –ï—Å–ª–∏ —ç—Ç–æ –¥—Ä—É–≥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞
    update.message.reply_text(
        "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –ø–æ–Ω–∏–º–∞—é —ç—Ç—É –∫–æ–º–∞–Ω–¥—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–æ–º.",
        reply_markup=get_main_keyboard()
    )

def init_bot_configuration():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–æ—Ç–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"""
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ —Ñ–∞–π–ª–∞
        config = get_bot_config()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–æ–ª–µ–π –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        if 'manager_username' not in config:
            config['manager_username'] = "willway_manager"
            logger.info("–î–æ–±–∞–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è manager_username")
        
        if 'trainer_username' not in config:
            config['trainer_username'] = "willway_trainer"
            logger.info("–î–æ–±–∞–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è trainer_username")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã help
        if 'commands' not in config:
            config['commands'] = {}
        
        config['commands']['/help'] = "–ü–æ–º–æ—â—å"
        logger.info("–û–±–Ω–æ–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /help –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        save_bot_config(config)
        
        logger.info("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞: {e}")
        return False

def initialize_bot():
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ Telegram
    """
    try:
        from telegram import Bot
        from dotenv import load_dotenv
        import os
        import logging
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        logger = logging.getLogger(__name__)
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        load_dotenv()
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
        TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
        
        if not TELEGRAM_TOKEN:
            logger.error("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
            return None
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞
        bot = Bot(token=TELEGRAM_TOKEN)
        logger.info("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        
        return bot
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞: {str(e)}")
        return None

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞."""
    try:
        logger.info("[STARTUP] –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ WILLWAY")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        init_bot_configuration()
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
        token = os.getenv("TELEGRAM_TOKEN")
        if not token:
            logger.error("–ù–µ —É–∫–∞–∑–∞–Ω TELEGRAM_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–∫—Å–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        proxy_url = os.getenv("TELEGRAM_PROXY_URL")
        
        # –°–æ–∑–¥–∞–µ–º updater —Å –ø—Ä–æ–∫—Å–∏ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
        if proxy_url:
            logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ–∫—Å–∏: {proxy_url}")
            # –°–æ–∑–¥–∞–µ–º —Ä–µ–∫–≤–µ—Å—Ç —Å –ø—Ä–æ–∫—Å–∏ –¥–ª—è telegram
            request = telegram.utils.request.Request(proxy_url=proxy_url)
            updater = Updater(token, request=request)
        else:
            # –û–±—ã—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ updater –±–µ–∑ –ø—Ä–æ–∫—Å–∏
            updater = Updater(token)
            
        dispatcher = updater.dispatcher
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ü–≤–µ—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        setup_colored_logging()
        
        # –ß–∏—Ç–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        config = get_bot_config()
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±–æ—Ç–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
        apply_bot_config(updater.bot, config)
        
        # –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∏–∞–ª–æ–≥–∞
        conv_handler = ConversationHandler(
            entry_points=[
                CommandHandler('start', start), 
                CommandHandler('survey', start_survey),
                MessageHandler(Filters.regex(r'^–ü–æ–¥–æ–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É$'), start_survey),
                CallbackQueryHandler(start_survey, pattern='^start_survey$')
            ],
            states={
                GENDER: [CallbackQueryHandler(gender, pattern='^(male|female)$')],
                AGE: [MessageHandler(Filters.text & ~Filters.command, age)],
                HEIGHT: [MessageHandler(Filters.text & ~Filters.command, height)],
                WEIGHT: [MessageHandler(Filters.text & ~Filters.command, weight)],
                MAIN_GOAL: [CallbackQueryHandler(main_goal)],
                ADDITIONAL_GOAL: [CallbackQueryHandler(additional_goal)],
                WORK_FORMAT: [CallbackQueryHandler(work_format)],
                SPORT_FREQUENCY: [CallbackQueryHandler(sport_frequency)],
                PAYMENT: [CallbackQueryHandler(payment)],
                SUPPORT_OPTIONS: [CallbackQueryHandler(handle_menu_callback)]
            },
            fallbacks=[CommandHandler('cancel', cancel)],
            name="survey_conversation"
        )
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        dispatcher.add_handler(conv_handler)
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
        dispatcher.add_handler(CommandHandler("start", start))
        dispatcher.add_handler(CommandHandler("menu", show_menu))
        dispatcher.add_handler(CommandHandler("payment", payment))
        dispatcher.add_handler(CommandHandler("subscription", check_subscription))
        dispatcher.add_handler(CommandHandler("help", help_command))
        
        # Webhook –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π –æ—Ç CloudPayments
        dispatcher.add_handler(MessageHandler(Filters.regex(r'^webhook_payment:'), webhook_handler))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≥–ª—É–±–æ–∫–∏—Ö —Å—Å—ã–ª–æ–∫ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
        dispatcher.add_handler(CommandHandler("start", start))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º
        dispatcher.add_handler(MessageHandler(Filters.regex(r'^Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç$'), health_assistant_button))
        dispatcher.add_handler(MessageHandler(Filters.regex(r'^üí¨ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å$'), health_assistant_button))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥–æ–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É"
        dispatcher.add_handler(MessageHandler(Filters.regex(r'^–ü–æ–¥–æ–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É$'), start_survey))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command & Filters.chat_type.private & Filters.regex(r'^\/#/'), handle_health_assistant_message))
        dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command & Filters.chat_type.private & Filters.regex(r'^support:/'), handle_support_messages))
        dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command & Filters.chat_type.private, handle_text_messages))
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ö–µ–º—ã —Å–æ–º–Ω–µ–Ω–∏–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ–¥–ø–∏—Å–∫–∏
        setup_subscription_doubt_handlers(dispatcher)
        logger.info("–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ö–µ–º—ã —Å–æ–º–Ω–µ–Ω–∏–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ–¥–ø–∏—Å–∫–∏")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ö–µ–º—ã –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏
        setup_subscription_cancel_handlers(dispatcher)
        logger.info("–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ö–µ–º—ã –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏")
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í–∞—Ä–∏–∞–Ω—Ç—ã WILLWAY –ø–æ–¥–ø–∏—Å–∫–∏"
        dispatcher.add_handler(CallbackQueryHandler(handle_show_subscription_options, pattern='^show_subscription_options$'))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–±—â–∏–π - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–º)
        dispatcher.add_handler(CallbackQueryHandler(handle_menu_callback))
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ —Ä–µ–∂–∏–º–µ webhook
        webhook_url = os.getenv("WEBHOOK_BASE_URL")
        token = os.getenv("TELEGRAM_TOKEN")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        if webhook_url:
            # –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ webhook
            port = int(os.getenv("PORT", "8443"))
            logger.info(f"[STARTUP] –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ webhook –Ω–∞ {webhook_url}")
            updater.start_webhook(
                listen="0.0.0.0",
                port=port,
                url_path=token,
                webhook_url=f"{webhook_url}/{token}"
            )
        else:
            # –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ polling (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º)
            logger.info("[STARTUP] –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ polling")
            updater.start_polling()
        
        logger.info("[STARTUP] –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
        
        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã
        updater.idle()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –≤ 10:00 —É—Ç—Ä–∞
        job_queue = updater.job_queue
        job_queue.run_daily(
            send_subscription_expiration_reminder,
            time=time(hour=10, minute=0, second=0),
            days=(0, 1, 2, 3, 4, 5, 6),
            context=None
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
        return

# –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ datetime
def make_aware(dt):
    """Localize a naive datetime object to the configured timezone"""
    if dt and not dt.tzinfo:
        return TIMEZONE.localize(dt)
    return dt

def is_admin(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
    session = get_session()
    try:
        admin = session.query(AdminUser).filter(AdminUser.user_id == user_id).first()
        return admin is not None
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {str(e)}")
        return False
    finally:
        session.close()

# –û–±–Ω–æ–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—é update_subscription_status –¥–ª—è –æ—Ç–º–µ–Ω—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
def update_subscription_status(user_id, context, send_welcome=False):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
        context: CallbackContext
        send_welcome: –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ
        
    Returns:
        bool: True –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, False –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ
    """
    session = get_session()
    user = session.query(User).filter(User.user_id == user_id).first()
    
    if not user:
        session.close()
        return False
    
    is_subscribed = False
    
    if user.is_subscribed and user.subscription_expires:
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ aware datetime –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        expiry_date = make_aware(user.subscription_expires)
        now = datetime.now(TIMEZONE)
        
        if expiry_date > now:
            is_subscribed = True
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ñ–ª–∞–≥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if send_welcome and context:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
                threading.Thread(
                    target=send_welcome_subscription_messages,
                    args=(context, user_id)
                ).start()
        else:
            # –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            user.is_subscribed = False
            session.commit()
    
    session.close()
    return is_subscribed

def check_subscription_status(user_id):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    Airtable –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.
    """
    session = get_session()
    user = session.query(User).filter(User.user_id == user_id).first()
    
    if user and user.is_subscribed and user.subscription_expires:
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ aware datetime –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        expiry_date = make_aware(user.subscription_expires)
        now = datetime.now(TIMEZONE)
        
        if expiry_date > now:
            paid_till = expiry_date.strftime("%Y-%m-%d")
            session.close()
            return True, paid_till
    
    session.close()
    return False, None

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
def check_subscription(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏."""
    user_id = update.effective_user.id
    is_subscribed = update_subscription_status(user_id, context, send_welcome=True)
    
    if is_subscribed:
        update.message.reply_text(
            "–£ –≤–∞—Å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞! ‚úÖ\n"
            "–í—ã –∏–º–µ–µ—Ç–µ –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞."
        )
    else:
        update.message.reply_text(
            "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏. ‚ùå\n"
            "–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ–ª–Ω–æ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É:",
            reply_markup=get_payment_keyboard(user_id, context)
        )
    
    return ConversationHandler.END

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ Telegram —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ Airtable
def link_telegram_with_tilda(update: Update, context: CallbackContext):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    user_id = update.effective_user.id
    
    update.message.reply_text(
        "–ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å–∫–∏...\n"
        "–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —ç—Ç–æ –∑–∞–π–º–µ—Ç –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥."
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
    is_subscribed, paid_till = check_subscription_status(user_id)
    
    if is_subscribed:
        update.message.reply_text(
            f"–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞! ‚úÖ\n\n"
            f"–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: –¥–æ {paid_till}"
        )
    else:
        # –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ñ–æ—Ä–º–∏—Ç—å
        update.message.reply_text(
            "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏.\n\n"
            "–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∏–∂–µ:",
            reply_markup=get_payment_keyboard(user_id, context)
        )
    
    return ConversationHandler.END

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
def show_menu(update: Update, context: CallbackContext):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –±–æ—Ç–∞."""
    user_id = update.effective_user.id
    logger.info(f"[MENU] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ—Ç–∫—Ä—ã–ª –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    is_subscribed = update_subscription_status(user_id, context)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    keyboard = [
        [InlineKeyboardButton("Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç", callback_data="health_assistant")],
        [InlineKeyboardButton("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π", callback_data="subscription_management")],
        [InlineKeyboardButton("–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π", callback_data="support")],
        [InlineKeyboardButton("–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞", callback_data="invite_friend")]
    ]
    
    update.message.reply_text(
        "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é WILLWAY:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    
    return ConversationHandler.END

def cancel(update: Update, context: CallbackContext) -> int:
    """–û—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏."""
    update.message.reply_text('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.')
    return ConversationHandler.END

def handle_text_messages(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–Ω–æ–ø–æ–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –∏ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π."""
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    message = update.message
    text = message.text
    user_id = message.from_user.id
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –æ—Ç–¥–µ–ª—å–Ω–æ, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    if text == "–ù–∞–∑–∞–¥":
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É '–ù–∞–∑–∞–¥', –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
        return back_to_main_menu(update, context)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏
    if 'cancellation' in context.user_data:
        logger.info(f"–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏: {text}")
        return False  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –ø–æ–∑–≤–æ–ª—è—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã reload –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if text == "/reload" or text == "reload":
        if is_admin(user_id):
            return reload_config(update, context)
        return
    
    # –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –ø–µ—Ä–µ–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    if context.user_data.get('health_assistant_active'):
        logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {text}")
        forward_to_health_assistant(update, context)
        return
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç"
    if text == "Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç":
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É 'Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç'")
        return health_assistant_button(update, context)
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π"
    if text == "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π":
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π'")
        try:
            session = get_session()
            user_db = session.query(User).filter(User.user_id == user_id).first()
            
            if user_db:
                is_subscribed = user_db.is_subscribed
                subscription_type = user_db.subscription_type
                subscription_expires = user_db.subscription_expires
                
                if is_subscribed and subscription_expires:
                    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
                    expires_date = subscription_expires.strftime("%d.%m.%Y")
                    remaining_days = (subscription_expires - datetime.now()).days
                    
                    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    sub_type = "–º–µ—Å—è—á–Ω–∞—è" if subscription_type == "monthly" else "–≥–æ–¥–æ–≤–∞—è"
                    
                    # –ü–æ–ª—É—á–∞–µ–º username –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                    config = get_bot_config()
                    manager_username = config.get("manager_username", "willway_manager")
                    
                    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–æ–π
                    keyboard = [
                        [InlineKeyboardButton("–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data="renew_subscription")],
                        [get_cancel_subscription_button()],
                        [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]
                    ]
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∫–µ
                    update.message.reply_text(
                        f"üíé *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ*\n\n"
                        f"‚Ä¢ –¢–∏–ø: {sub_type}\n"
                        f"‚Ä¢ –ê–∫—Ç–∏–≤–Ω–∞ –¥–æ: {expires_date}\n"
                        f"‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: {remaining_days}\n\n"
                        f"–î–ª—è –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞–∂–º–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
                        parse_mode=ParseMode.MARKDOWN,
                        reply_markup=InlineKeyboardMarkup(keyboard)
                    )
                else:
                    # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
                    update.message.reply_text(
                        "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏.\n\n"
                        "–û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É –∏ –¥—Ä—É–≥–∏–º —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞:",
                        reply_markup=get_payment_keyboard_inline(user_id)
                    )
            else:
                # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                update.message.reply_text(
                    "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å–∫–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]])
                )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∫–µ: {e}")
            update.message.reply_text(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∫–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]])
            )
        finally:
            if 'session' in locals() and session:
                session.close()
        return
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π"
    if text == "–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π":
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É '–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π'")
        update.message.reply_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ —Å –∫–µ–º —Ö–æ—Ç–∏—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è:",
            reply_markup=support_keyboard()
        )
        return
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞"
    if text == "–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞":
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É '–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞'")
        # –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        session = get_session()
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
            ref_code = session.query(ReferralCode).filter(
                ReferralCode.user_id == user_id, 
                ReferralCode.is_active == True
            ).first()
            
            if not ref_code:
                # –ï—Å–ª–∏ –∫–æ–¥–∞ –Ω–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π
                import random
                import string
                new_code = ''.join(random.choices(string.ascii_uppercase + string.digits, k=8))
                
                ref_code = ReferralCode(
                    user_id=user_id,
                    code=new_code,
                    is_active=True
                )
                session.add(ref_code)
                session.commit()
                
                code = new_code
                logger.info(f"[REFERRAL] –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ {code} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            else:
                code = ref_code.code
                logger.info(f"[REFERRAL] –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ {code} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π
            total_invited = session.query(ReferralUse).filter(
                ReferralUse.referrer_id == user_id
            ).count()
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä—É–∑–µ–π, –æ–ø–ª–∞—Ç–∏–≤—à–∏—Ö –ø–æ–¥–ø–∏—Å–∫—É
            paid_friends = session.query(ReferralUse).filter(
                ReferralUse.referrer_id == user_id,
                ReferralUse.subscription_purchased == True
            ).count()
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –±–æ—Ç–∞
            bot_username = os.environ.get('TELEGRAM_BOT_USERNAME', 'willwayapp_bot')  # –ü–æ–ª—É—á–∞–µ–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
            try:
                bot_info = context.bot.get_me()
                bot_username = bot_info.username
            except:
                logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å username –±–æ—Ç–∞")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
            referral_link = f"https://t.me/{bot_username}?start={code}"
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            message = (
                "–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã!\n\n"
                "–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–π–¥–µ—Ç –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ –∏ –æ—Ñ–æ—Ä–º–∏—Ç –ø–æ–¥–ø–∏—Å–∫—É, "
                "–≤—ã –ø–æ–ª—É—á–∏—Ç–µ +1 –º–µ—Å—è—Ü –∫ –≤–∞—à–µ–π —Ç–µ–∫—É—â–µ–π –ø–æ–¥–ø–∏—Å–∫–µ.\n\n"
                "–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
                f"- –í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π: {total_invited}\n"
                f"- –î—Ä—É–∑–µ–π —Å –ø–æ–¥–ø–∏—Å–∫–æ–π: {paid_friends}\n"
                f"- –ë–æ–Ω—É—Å–Ω—ã—Ö –º–µ—Å—è—Ü–µ–≤ –ø–æ–ª—É—á–µ–Ω–æ: {paid_friends}\n\n"
                f"–í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: {code}\n"
            )
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            keyboard = InlineKeyboardMarkup([
                [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]
            ])
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            update.message.reply_text(
                text=message,
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=keyboard
            )
            
        except Exception as e:
            logger.error(f"[REFERRAL_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥—Ä—É–≥–∞: {str(e)}")
            update.message.reply_text(
                text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≤–∞—à–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]])
            )
        finally:
            session.close()
        return
        
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    session = get_session()
    try:
        user_db = session.query(User).filter(User.user_id == user_id).first()
        
        if not user_db or not user_db.is_subscribed:
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏")
            
            # –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏
            if context.user_data.get('health_assistant_active'):
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                context.user_data['health_assistant_active'] = False
                
                update.message.reply_text(
                    "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞.\n\n"
                    "–û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø:",
                    reply_markup=get_payment_keyboard_inline(user_id)
                )
            return
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞: {e}")
    finally:
        session.close()
    
    # –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –≤—ã–≤–æ–¥–∏–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    logger.info(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
    show_menu(update, context)

def cancel_payment_reminder(context, user_id):
    jobs = context.job_queue.get_jobs_by_name(f"payment_reminder_{user_id}")
    for job in jobs:
        job.schedule_removal()
        logger.info(f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ—Ç–º–µ–Ω–µ–Ω–æ")

def send_welcome_subscription_messages(context, user_id):
    logger.info(f"[SUBSCRIPTION_WELCOME] –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
    
    try:
        session = get_session()
        user = session.query(User).filter(User.user_id == user_id).first()
        
        if not user:
            logger.error(f"[SUBSCRIPTION_WELCOME] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
            return
        
        config = get_bot_config()
        channel_url = config.get("channel_url", "https://t.me/willway_channel")
        
        welcome_text = (
            "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ WILLWAY!\n\n"
            "–Ø —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –¥–æ—Å—Ç–∏—á—å —Ç–≤–æ–∏—Ö —Ü–µ–ª–µ–π "
            "–≤ —Ñ–∏—Ç–Ω–µ—Å–µ –∏ –∑–¥–æ—Ä–æ–≤–æ–º –æ–±—Ä–∞–∑–µ –∂–∏–∑–Ω–∏.\n\n"
            "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, —Ç–µ–±–µ –Ω—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫–æ—Ä–æ—Ç–∫—É—é –∞–Ω–∫–µ—Ç—É. "
            "–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –º–Ω–µ –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å —Ç–≤–æ–∏ —Ü–µ–ª–∏ –∏ –ø–æ–¥–æ–±—Ä–∞—Ç—å "
            "–æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫."
        )
        
        # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –∫–∞–Ω–∞–ª–∞
        keyboard = [
            [InlineKeyboardButton("–î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é", url="https://willway.pro/app")],
            [InlineKeyboardButton("–í—Å—Ç—É–ø–∏—Ç—å –≤ –∫–∞–Ω–∞–ª", url=channel_url)]
        ]
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
        context.bot.send_message(
            chat_id=user_id,
            text=welcome_text,
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        
        logger.info(f"[SUBSCRIPTION_WELCOME] –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
    except Exception as e:
        logger.error(f"[SUBSCRIPTION_WELCOME_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
    finally:
        if 'session' in locals():
            session.close()

# –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
def activate_test_subscription(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)."""
    query = update.callback_query
    query.answer()
    
    # –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ callback_data
    callback_data = query.data
    user_id = callback_data.split('_')[2]
    
    try:
        user_id = int(user_id)
    except ValueError:
        logger.error(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ callback_data: {callback_data}")
        query.edit_message_text("–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return
    
    # –û—Ç–º–µ–Ω—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ
    cancel_payment_reminder(context, user_id)
    
    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    session = get_session()
    user = session.query(User).filter(User.user_id == user_id).first()
    
    if not user:
        logger.error(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
        query.edit_message_text("–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Å –∫–æ–º–∞–Ω–¥—ã /start")
        session.close()
        return
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ 30 –¥–Ω–µ–π
    user.is_subscribed = True
    user.subscription_expires = datetime.now(TIMEZONE) + timedelta(days=30)
    expiry_date = user.subscription_expires.strftime("%d.%m.%Y")
    
    session.commit()
    logger.info(f"–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –¥–æ {expiry_date}")
    session.close()
    
    # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
    query.edit_message_text(
        f"‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!\n\n"
        f"–°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–Ω–∞\n"
        f"–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {expiry_date}\n\n"
        f"–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –±–æ—Ç–∞."
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–µ—Ä–∏—é –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    send_welcome_subscription_messages(context, user_id)
    
# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —à–∞–≥–æ–≤
def gender_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª–∞."""
    keyboard = [
        [InlineKeyboardButton("–ú—É–∂—Å–∫–æ–π", callback_data="male")],
        [InlineKeyboardButton("–ñ–µ–Ω—Å–∫–∏–π", callback_data="female")]
    ]
    return InlineKeyboardMarkup(keyboard)

def main_goal_keyboard():
    keyboard = [
        [InlineKeyboardButton("‚òëÔ∏è –°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞", callback_data="goal_1")],
        [InlineKeyboardButton("‚òëÔ∏è –ù–∞–±–æ—Ä –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã", callback_data="goal_2")],
        [InlineKeyboardButton("‚òëÔ∏è –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –æ—Å–∞–Ω–∫–∏", callback_data="goal_3")],
        [InlineKeyboardButton("‚òëÔ∏è –£–±—Ä–∞—Ç—å –∑–∞–∂–∞—Ç–æ—Å—Ç—å –≤ —Ç–µ–ª–µ", callback_data="goal_4")],
        [InlineKeyboardButton("‚òëÔ∏è –û–±—â–∏–π —Ç–æ–Ω—É—Å/—Ä–µ–ª—å–µ—Ñ –º—ã—à—Ü", callback_data="goal_5")],
        [InlineKeyboardButton("‚òëÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ø–æ—Å–ª–µ —Ä–æ–¥–æ–≤", callback_data="goal_6")],
        [InlineKeyboardButton("‚òëÔ∏è –°–Ω—è—Ç—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ", callback_data="goal_7")],
        [InlineKeyboardButton("‚òëÔ∏è –£–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞", callback_data="goal_8")],
        [InlineKeyboardButton("‚òëÔ∏è –°—Ç–∞—Ç—å –±–æ–ª–µ–µ —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–º", callback_data="goal_9")],
        [InlineKeyboardButton("–ì–æ—Ç–æ–≤–æ ‚úì", callback_data="goals_done")]
    ]
    return InlineKeyboardMarkup(keyboard)

def additional_goal_keyboard():
    keyboard = [
        [InlineKeyboardButton("‚òëÔ∏è –ü–æ—Å–ª—É—à–∞—Ç—å –ª–µ–∫—Ü–∏–∏ –æ—Ç –≤—Ä–∞—á–µ–π, —Ç—Ä–µ–Ω–µ—Ä–æ–≤", callback_data="add_goal_1")],
        [InlineKeyboardButton("‚òëÔ∏è –ü–æ—Å–ª—É—à–∞—Ç—å –ª–µ–∫—Ü–∏–∏ –æ—Ç –ø—Ä–æ—Ñ –ø—Å–∏—Ö–æ–ª–æ–≥–æ–≤", callback_data="add_goal_2")],
        [InlineKeyboardButton("‚òëÔ∏è –ë–æ–ª—å—à–µ —É–∑–Ω–∞—Ç—å –æ –∑–¥–æ—Ä–æ–≤–æ–º –ø–∏—Ç–∞–Ω–∏–∏", callback_data="add_goal_3")],
        [InlineKeyboardButton("‚òëÔ∏è –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–≤–æ—é –∂–∏–∑–Ω—å –º–µ–¥–∏—Ç–∞—Ü–∏–∏, –ø—Ä–∞–∫—Ç–∏–∫–∏", callback_data="add_goal_4")],
        [InlineKeyboardButton("‚òëÔ∏è –û–±—Ä–µ—Å—Ç–∏ –Ω–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞", callback_data="add_goal_5")],
        [InlineKeyboardButton("‚òëÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞, –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å, –º–æ—Ç–∏–≤–∞—Ü–∏—è", callback_data="add_goal_6")],
        [InlineKeyboardButton("–ì–æ—Ç–æ–≤–æ ‚úì", callback_data="additional_goals_done")]
    ]
    return InlineKeyboardMarkup(keyboard)

def work_format_keyboard():
    keyboard = [
        [InlineKeyboardButton("–ú–Ω–æ–≥–æ —Å–∏–∂—É –∑–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–º", callback_data="–°–∏–¥—è—á–∞—è —Ä–∞–±–æ—Ç–∞")],
        [InlineKeyboardButton("–ú–∞–º–∞ –≤ –¥–µ–∫—Ä–µ—Ç–µ", callback_data="–ú–∞–º–∞ –≤ –¥–µ–∫—Ä–µ—Ç–µ")],
        [InlineKeyboardButton("–ù–µ —Ä–∞–±–æ—Ç–∞—é (–Ω–∞ —Ä–∞—Å–ª–∞–±–æ–Ω–µ, –Ω–∞ —á–∏–ª–µ)", callback_data="–ù–µ —Ä–∞–±–æ—Ç–∞—é")],
        [InlineKeyboardButton("–ß–∞—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∏", callback_data="–ß–∞—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∏")],
        [InlineKeyboardButton("–†–∞–±–æ—Ç–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞", callback_data="–§–∏–∑–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞")]
    ]
    return InlineKeyboardMarkup(keyboard)

def sport_frequency_keyboard():
    keyboard = [
        [InlineKeyboardButton("1-2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é", callback_data="1-2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é")],
        [InlineKeyboardButton("3-4 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é", callback_data="3-4 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é")],
        [InlineKeyboardButton("5-6 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é", callback_data="5-6 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é")],
        [InlineKeyboardButton("–ö–∞–∂–¥—ã–π –¥–µ–Ω—å", callback_data="–ö–∞–∂–¥—ã–π –¥–µ–Ω—å")],
        [InlineKeyboardButton("–ù–µ –∑–∞–Ω–∏–º–∞—é—Å—å", callback_data="–ù–µ –∑–∞–Ω–∏–º–∞—é—Å—å")]
    ]
    return InlineKeyboardMarkup(keyboard)

def payment_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏."""
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏–∑ –º–æ–¥—É–ª—è —Å–æ–º–Ω–µ–Ω–∏–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ–¥–ø–∏—Å–∫–∏
    from bot.subscription_doubt_handler import get_subscription_keyboard
    return get_subscription_keyboard()
    
def get_incomplete_payment_keyboard(user_id):
    keyboard = [
        [InlineKeyboardButton("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_menu")]
    ]
    return InlineKeyboardMarkup(keyboard)

def send_incomplete_payment_reminder(context: CallbackContext):
    logger.info("[PAYMENT_DISABLED] –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –æ–ø–ª–∞—Ç–µ –æ—Ç–∫–ª—é—á–µ–Ω–∞")
    return

def schedule_payment_reminder(context, user_id, delay_minutes=0.02):
    logger.info("[PAYMENT_DISABLED] –§—É–Ω–∫—Ü–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –æ–ø–ª–∞—Ç–µ –æ—Ç–∫–ª—é—á–µ–Ω–∞")
    return

def send_test_reminder(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    
    update.message.reply_text(
        "–¢–µ—Å—Ç–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É"
    )
    
    schedule_payment_reminder(context, user_id, delay_minutes=1)
    
def main_goal_texts():
    return {
        "–£–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–π –≤–µ—Å": "–¢–≤–æ—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —É–∂–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ üèÜ \n\n–ß—Ç–æ–±—ã –¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–∏ ¬´–£–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–π –≤–µ—Å¬ª –º—ã –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –≤ 3-—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö:\n\n1Ô∏è‚É£ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\n‚úì 3 –º–µ—Å—è—Ü–∞ —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º –æ–Ω-–ª–∞–π–Ω\n‚úì –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞\n‚úì –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ –∏ –Ω–∞–≥—Ä—É–∑–∫–µ\n‚úì –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n\n2Ô∏è‚É£ –ü–∏—Ç–∞–Ω–∏–µ\n‚úì –ø–æ–¥–±–æ—Ä –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è –∏—Å—Ö–æ–¥—è –∏–∑ —Ü–µ–ª–µ–π\n‚úì –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è\n‚úì –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å\n‚úì –ª–µ–∫—Ü–∏–∏ –æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–∏—Ç–∞–Ω–∏–∏\n\n3Ô∏è‚É£ –û–±—Ä–∞–∑ –∂–∏–∑–Ω–∏\n‚úì –ª–µ–∫—Ü–∏–∏ –æ —Å—Ç—Ä–µ—Å—Å–µ, —Å–Ω–µ, —É–∫—Ä–µ–ø–ª–µ–Ω–∏–∏ –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞\n‚úì –ª–µ–∫—Ü–∏–∏ –æ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏ —Ä–µ–∂–∏–º–µ\n\n–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–∞–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã 7 990 —Ä—É–±. –∑–∞ 3 –º–µ—Å—è—Ü–∞.",
        "–ù–∞–±—Ä–∞—Ç—å –º—ã—à–µ—á–Ω—É—é –º–∞—Å—Å—É": "–¢–≤–æ—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —É–∂–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ üèÜ \n\n–ß—Ç–æ–±—ã –¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–∏ ¬´–ù–∞–±—Ä–∞—Ç—å –º—ã—à–µ—á–Ω—É—é –º–∞—Å—Å—É¬ª –º—ã –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –≤ 3-—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö:\n\n1Ô∏è‚É£ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\n‚úì 3 –º–µ—Å—è—Ü–∞ —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º –æ–Ω-–ª–∞–π–Ω\n‚úì –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å —É—á—ë—Ç–æ–º –≤—Å–µ—Ö –º—ã—à–µ—á–Ω—ã—Ö –≥—Ä—É–ø–ø, –æ–±—ä–µ–º–∞ –Ω–∞–≥—Ä—É–∑–∫–∏\n‚úì –ü–æ–¥–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π, –∞–∫—Ü–µ–Ω—Ç–æ–≤ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–≤–∏–∂–µ–Ω–∏–π, –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç—Å—Ç–∞—é—â–∏–µ –≥—Ä—É–ø–ø—ã –º—ã—à—Ü\n‚úì –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ –∏ –Ω–∞–≥—Ä—É–∑–∫–µ\n‚úì –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã —á–µ—Ä–µ–∑ –∫–∞–∂–¥—ã–µ 3 –Ω–µ–¥–µ–ª–∏\n\n2Ô∏è‚É£ –ü–∏—Ç–∞–Ω–∏–µ\n‚úì –ø–æ–¥–±–æ—Ä –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è –∏—Å—Ö–æ–¥—è –∏–∑ —Ü–µ–ª–µ–π\n‚úì –∫–∞–ª—å–∫—É–ª—è—Ü–∏—è –ö–ë–ñ–£ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n‚úì –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è\n‚úì –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å\n‚úì –ª–µ–∫—Ü–∏–∏ –æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–∏—Ç–∞–Ω–∏–∏ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –º–∞—Å—Å—ã\n\n3Ô∏è‚É£ –û–±—Ä–∞–∑ –∂–∏–∑–Ω–∏\n‚úì –ª–µ–∫—Ü–∏–∏ –æ —Å—Ç—Ä–µ—Å—Å–µ, —Å–Ω–µ, –Ω–µ—Ä–≤–Ω–æ–π —Ä–µ–≥—É–ª—è—Ü–∏–∏\n‚úì –ª–µ–∫—Ü–∏–∏ –æ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏ —Ä–µ–∂–∏–º–µ\n\n–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–∞–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã 7 990 —Ä—É–±. –∑–∞ 3 –º–µ—Å—è—Ü–∞.",
        "–ü–æ–≤—ã—Å–∏—Ç—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": "–¢–≤–æ—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —É–∂–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ üèÜ \n\n–ß—Ç–æ–±—ã –¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–∏ ¬´–ü–æ–≤—ã—Å–∏—Ç—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å¬ª –º—ã –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –≤ 3-—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö:\n\n1Ô∏è‚É£ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\n‚úì 3 –º–µ—Å—è—Ü–∞ —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º –æ–Ω-–ª–∞–π–Ω\n‚úì –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞\n‚úì —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n‚úì –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ –Ω–∞–≥—Ä—É–∑–∫–∞–º\n\n2Ô∏è‚É£ –ü–∏—Ç–∞–Ω–∏–µ\n‚úì –ø–æ–¥–±–æ—Ä –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è –∏—Å—Ö–æ–¥—è –∏–∑ —Ü–µ–ª–µ–π\n‚úì –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è\n‚úì –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å\n‚úì —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é, –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–∞–º\n\n3Ô∏è‚É£ –û–±—Ä–∞–∑ –∂–∏–∑–Ω–∏\n‚úì –ª–µ–∫—Ü–∏–∏ –æ —Å—Ç—Ä–µ—Å—Å–µ, —Å–Ω–µ, —É–∫—Ä–µ–ø–ª–µ–Ω–∏–∏ –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞\n‚úì –ª–µ–∫—Ü–∏–∏ –æ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏ —Ä–µ–∂–∏–º–µ\n\n–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–∞–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã 7 990 —Ä—É–±. –∑–∞ 3 –º–µ—Å—è—Ü–∞."
    }

def additional_goal_texts():
    return {
        "–ü–æ—Å–ª—É—à–∞—Ç—å –ª–µ–∫—Ü–∏–∏ –æ—Ç –≤—Ä–∞—á–µ–π, —Ç—Ä–µ–Ω–µ—Ä–æ–≤": "–¢—ã –ø–æ–ª—É—á–∏—à—å –¥–æ—Å—Ç—É–ø –∫ –ª–µ–∫—Ü–∏—è–º –æ—Ç –≤—Ä–∞—á–µ–π –∏ —Ç—Ä–µ–Ω–µ—Ä–æ–≤ –ø–æ —Ç–µ–º–∞–º –∑–¥–æ—Ä–æ–≤—å—è, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ —Ä–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏–∏.",
        "–ü–æ—Å–ª—É—à–∞—Ç—å –ª–µ–∫—Ü–∏–∏ –æ—Ç –ø—Ä–æ—Ñ –ø—Å–∏—Ö–æ–ª–æ–≥–æ–≤": "–í –ø—Ä–æ–≥—Ä–∞–º–º—É –≤–∫–ª—é—á–µ–Ω—ã –ª–µ–∫—Ü–∏–∏ –æ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø—Å–∏—Ö–æ–ª–æ–≥–æ–≤ –æ –º–æ—Ç–∏–≤–∞—Ü–∏–∏, –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–∏ –±–∞—Ä—å–µ—Ä–æ–≤ –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ –∑–¥–æ—Ä–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏.",
        "–ë–æ–ª—å—à–µ —É–∑–Ω–∞—Ç—å –æ –∑–¥–æ—Ä–æ–≤–æ–º –ø–∏—Ç–∞–Ω–∏–∏": "–¢–µ–±—è –∂–¥—É—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ –∑–¥–æ—Ä–æ–≤–æ–º –ø–∏—Ç–∞–Ω–∏–∏, —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞—Ü–∏–æ–Ω–∞ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ–¥—Ö–æ–¥–µ –∫ –ø—Ä–∏–µ–º—É –ø–∏—â–∏.",
        "–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–≤–æ—é –∂–∏–∑–Ω—å –º–µ–¥–∏—Ç–∞—Ü–∏–∏, –ø—Ä–∞–∫—Ç–∏–∫–∏": "–ü—Ä–æ–≥—Ä–∞–º–º–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ–¥–∏—Ç–∞—Ü–∏–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Å–Ω–∏–∂–µ–Ω–∏—è —Å—Ç—Ä–µ—Å—Å–∞.",
        "–û–±—Ä–µ—Å—Ç–∏ –Ω–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞": "–¢—ã —Å—Ç–∞–Ω–µ—à—å —á–∞—Å—Ç—å—é —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤, –≥–¥–µ —Å–º–æ–∂–µ—à—å –æ–±—â–∞—Ç—å—Å—è –∏ –∑–∞–≤–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞.",
        "–ü–æ–¥–¥–µ—Ä–∂–∫–∞, –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å, –º–æ—Ç–∏–≤–∞—Ü–∏—è": "–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—Ä–µ–Ω–µ—Ä–∞, —Ä–µ–≥—É–ª—è—Ä–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ–º–æ–≥—É—Ç —Ç–µ–±–µ –¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–µ–π."
    }
    

def webhook_handler(update: Update, context: CallbackContext):
    logger.info("[PAYMENT_DISABLED] –ü–æ–ª—É—á–µ–Ω webhook (—Å–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω–∞)")
    return

def create_payment_record(user_id, subscription_type, payment_amount, payment_status='pending'):
    logger.info(f"[PAYMENT_DISABLED] –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –æ –ø–ª–∞—Ç–µ–∂–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}, —Ç–∏–ø {subscription_type})")
    return False

def generate_payment_url(user_id, subscription_type):
    logger.info(f"[PAYMENT_DISABLED] –ü–æ–ø—ã—Ç–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ URL –æ–ø–ª–∞—Ç—ã (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}, —Ç–∏–ø {subscription_type})")
    return None

def send_successful_payment_messages(update: Update, context: CallbackContext, subscription_status):
    user_id = update.effective_user.id if update else context.user_data.get('user_id')
    logger.info(f"[PAYMENT_DISABLED] –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})")
    return

def send_payment_processing_messages(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    logger.info(f"[PAYMENT_DISABLED] –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})")
    return

def check_payment_status_job(context: CallbackContext):
    logger.info("[PAYMENT_DISABLED] –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞")
    return

def handle_support_messages(update, context):
    text = update.message.text
    user_id = update.effective_user.id
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤ –º–µ–Ω—é –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤—ã–±—Ä–∞–ª: {text}")

    keyboard = [
        [KeyboardButton("Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç")],
        [KeyboardButton("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π")],
        [KeyboardButton("–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π")],
        [KeyboardButton("–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞")]
    ]
    
    main_kb = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

    if text == "–°–≤—è–∑–∞—Ç—å—Å—è —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º":
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—Ä–µ–Ω–µ—Ä–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        config = get_bot_config()
        trainer_username = config.get('trainer_username', '')
        
        if trainer_username:
            update.message.reply_text(
                f"–í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º —á–µ—Ä–µ–∑ Telegram: @{trainer_username}",
                reply_markup=main_kb
            )
        else:
            update.message.reply_text(
                "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=main_kb
            )
    
    elif text == "–°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º":
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        config = get_bot_config()
        manager_username = config.get('manager_username', '')
        
        if manager_username:
            update.message.reply_text(
                f"–í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º —á–µ—Ä–µ–∑ Telegram: @{manager_username}",
                reply_markup=main_kb
            )
        else:
            update.message.reply_text(
                "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=main_kb
            )
    
    elif text == "–ú–µ–Ω—é ‚úÖ":
        update.message.reply_text(
            "–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", 
            reply_markup=main_kb
        )

def handle_other_messages(update, context):
    user_id = update.effective_user.id
    text = update.message.text
    logger.info(f"[OTHER_MESSAGE] –ü–æ–ª—É—á–µ–Ω–æ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {text}")
    
    if text == "–ü–æ–¥–æ–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É":
        logger.info(f"[SURVEY_START] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞–∂–∞–ª –Ω–∞ –∫–Ω–æ–ø–∫—É '–ü–æ–¥–æ–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É'")
        return start_survey(update, context)
    
    update.message.reply_text(
        "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –ø–æ–Ω–∏–º–∞—é —ç—Ç—É –∫–æ–º–∞–Ω–¥—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–æ–º.",
        reply_markup=get_main_keyboard()
    )

def send_subscription_expiration_reminder(context: CallbackContext):
    message = (
        "–ü—Ä–∏–≤–µ—Ç! –ù–∞–ø–æ–º–∏–Ω–∞—é, —á—Ç–æ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–≤–æ–µ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É.\n\n"
        "–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –±–æ—Ç–∞, "
        "—Ç–µ–±–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É."
    )

PAYMENT_STATUS = {
    'PENDING': 'pending',
    'PROCESSING': 'processing',
    'COMPLETED': 'completed',
    'FAILED': 'failed',
    'CANCELLED': 'cancelled',
    'REDIRECTED': 'redirected',
    'EXPIRED': 'expired'
}

PAYMENT_SCENARIOS = {
    'SUCCESS': 'success',
    'TIMEOUT': 'timeout',
    'ERROR': 'error',
    'CANCEL': 'cancel'
}

MONTHLY_SUBSCRIPTION_PRICE = 1555
YEARLY_SUBSCRIPTION_PRICE = 13333

class PaymentTracker:
    def __init__(self, session=None):
        self.session = session
        
    def log_payment_event(self, user_id, event_type, payment_id=None, status=None, data=None):
        return None
        
    def track_payment_initiation(self, user_id, amount, subscription_type, payment_data=None):
        return None
        
    def track_payment_redirect(self, user_id, payment_id, payment_url):
        return None
        
    def track_payment_completion(self, user_id, payment_id, status, amount=None, subscription_type=None, subscription_expires=None, payment_data=None):
        return None
        
    def track_payment_error(self, user_id, payment_id, error_message, payment_data=None):
        return None
        
    def get_payment_status(self, user_id):
        return {'status': 'disabled'}
        
    def run_payment_scenario(self, scenario_type, user_id, payment_id=None):
        return None

class PaymentHandler:
    def __init__(self):
        pass
        
    def generate_tilda_payment_link(self, user_data, subscription_type):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã Tilda"""
        user_id = user_data.get('user_id')
        logger.info(f"[PAYMENT] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã Tilda –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–π URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–ø–ª–∞—Ç—ã
        payment_url = "https://willway.pro/payment"
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        full_url = f"{payment_url}?tgid={user_id}"
        
        logger.info(f"[PAYMENT] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å—Å—ã–ª–∫–∞: {full_url}")
        return full_url
        
    def process_webhook(self, webhook_data):
        return {'success': False, 'error': '–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞'}

class CloudPaymentAdapter:
    def __init__(self):
        pass
        
    def generate_payment_url(self, amount, currency, invoice_id, description, account_id, email, data=None):
        return None

def get_payment_keyboard_inline(user_id):
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ü–µ–Ω—ã —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á –∏ —Å–∏–º–≤–æ–ª–æ–º —Ä—É–±–ª—è
    monthly_price = f"{MONTHLY_SUBSCRIPTION_PRICE:,}".replace(",", " ") + " ‚ÇΩ"
    yearly_price = f"{YEARLY_SUBSCRIPTION_PRICE:,}".replace(",", " ") + " ‚ÇΩ"
    
    # –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —ç–∫–æ–Ω–æ–º–∏–∏ –ø—Ä–∏ –≥–æ–¥–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–µ
    monthly_yearly = MONTHLY_SUBSCRIPTION_PRICE * 12
    savings_percent = round((monthly_yearly - YEARLY_SUBSCRIPTION_PRICE) / monthly_yearly * 100)
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º callback –≤–º–µ—Å—Ç–æ URL
    keyboard = [
        [InlineKeyboardButton("–í–∞—Ä–∏–∞–Ω—Ç—ã WILLWAY –ø–æ–¥–ø–∏—Å–∫–∏:", callback_data="show_subscription_options")],
        [InlineKeyboardButton("–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_menu")]
    ]
    return InlineKeyboardMarkup(keyboard)

def save_bot_config(config):
    try:
        BOT_CONFIG_FILE = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'bot_config.json')
        
        with open(BOT_CONFIG_FILE, 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=4)
        
        logger.info(f"–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª {BOT_CONFIG_FILE}")
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞: {e}")
        return False

def help_command(update: Update, context: CallbackContext):
    message = (
        "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ WILLWAY.\n\n"
        "–ï—Å–ª–∏ —É —Ç–µ–±—è –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Ç–µ–±–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, "
        "—Ç—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—à—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞—à–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:"
    )

__all__ = ['get_bot_config']

def get_referral_keyboard(user_id, ref_code):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã"""
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Ç–æ–ª—å–∫–æ —Å –∫–Ω–æ–ø–∫–æ–π –ù–∞–∑–∞–¥
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]
    ])
    
    return keyboard, ref_code

def invite_friend(update: Update, context: CallbackContext):
    """–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã"""
    user_id = update.effective_user.id
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞
    if update.callback_query:
        query = update.callback_query
        query.answer()
    else:
        query = None
    
    session = get_session()
    try:
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
        user_db = session.query(User).filter(User.user_id == user_id).first()
        if not user_db:
            logger.error(f"[REFERRAL_ERROR] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
            message = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ."
            if query:
                query.edit_message_text(message, reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]]))
            else:
                context.bot.send_message(chat_id=user_id, text=message)
            session.close()
            return
            
        # –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
        try:
            # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ is_active
            ref_code = session.query(ReferralCode).filter(ReferralCode.user_id == user_db.id, ReferralCode.is_active == True).first()
        except Exception as e:
            logger.warning(f"[REFERRAL_WARNING] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ is_active: {str(e)}")
            try:
                # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ active
                ref_code = session.query(ReferralCode).filter(ReferralCode.user_id == user_db.id, ReferralCode.active == True).first()
            except Exception as e2:
                logger.warning(f"[REFERRAL_WARNING] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ active: {str(e2)}")
                # –ï—Å–ª–∏ –∏ —Ç–∞–∫ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –±–µ—Ä–µ–º –ª—é–±–æ–π –∫–æ–¥
                ref_code = session.query(ReferralCode).filter(ReferralCode.user_id == user_db.id).first()
        
        # –ï—Å–ª–∏ –∫–æ–¥–∞ –Ω–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π
        if not ref_code:
            import random
            import string
            new_code = ''.join(random.choices(string.ascii_uppercase + string.digits, k=8))
            logger.info(f"[REFERRAL] –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ {new_code} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥
            ref_code = ReferralCode(user_id=user_db.id, code=new_code)
            try:
                ref_code.is_active = True
            except:
                try:
                    ref_code.active = True
                except:
                    pass
                
            session.add(ref_code)
            session.commit()
            code = new_code
        else:
            code = ref_code.code
            
        logger.info(f"[REFERRAL] –ö–æ–¥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {code}")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –∏ –æ–ø–ª–∞—Ç–∏–≤—à–∏—Ö
        total_invited = 0
        paid_friends = 0
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π
            total_invited = session.query(ReferralUse).filter(
                ReferralUse.referrer_id == user_db.id
            ).count()
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä—É–∑–µ–π, –∫—É–ø–∏–≤—à–∏—Ö –ø–æ–¥–ø–∏—Å–∫—É
            paid_friends = session.query(ReferralUse).filter(
                ReferralUse.referrer_id == user_db.id,
                ReferralUse.subscription_purchased == True
            ).count()
        except Exception as e:
            logger.error(f"[REFERRAL_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {str(e)}")
            
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Å–ª–æ–∂–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        message = (
            "–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã!\n\n"
            "üéÅ –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã!\n\n"
            "–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–π–¥–µ—Ç –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ –∏ –æ—Ñ–æ—Ä–º–∏—Ç –ø–æ–¥–ø–∏—Å–∫—É, "
            "–≤—ã –ø–æ–ª—É—á–∏—Ç–µ +1 –º–µ—Å—è—Ü –∫ –≤–∞—à–µ–π —Ç–µ–∫—É—â–µ–π –ø–æ–¥–ø–∏—Å–∫–µ.\n\n"
            "üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
            f"‚Ä¢ –í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π: {total_invited}\n"
            f"‚Ä¢ –î—Ä—É–∑–µ–π —Å –ø–æ–¥–ø–∏—Å–∫–æ–π: {paid_friends}\n"
            f"‚Ä¢ –ë–æ–Ω—É—Å–Ω—ã—Ö –º–µ—Å—è—Ü–µ–≤ –ø–æ–ª—É—á–µ–Ω–æ: {paid_friends}\n\n"
            f"–í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: {code}\n"
        )
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]
        ])
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Å–ª–æ–∂–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if query:
            try:
                query.edit_message_text(message, reply_markup=keyboard)
            except Exception as e:
                logger.error(f"[REFERRAL_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {str(e)}")
                context.bot.send_message(chat_id=user_id, text=message, reply_markup=keyboard)
        else:
            context.bot.send_message(chat_id=user_id, text=message, reply_markup=keyboard)
            
    except Exception as e:
        logger.error(f"[REFERRAL_ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥—Ä—É–≥–∞: {str(e)}")
        message = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ."
        if query:
            try:
                query.edit_message_text(message, reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]]))
            except:
                context.bot.send_message(chat_id=user_id, text=message, reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]]))
        else:
            context.bot.send_message(chat_id=user_id, text=message, reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back_to_menu")]]))
    finally:
        session.close()

def handle_copy_ref_link(update: Update, context: CallbackContext):
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    query = update.callback_query
    query.answer("–ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!")
    
    callback_data = query.data
    ref_code = callback_data.replace("copy_ref_link", "").strip("_")
    
    user_id = update.effective_user.id
    
    # –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    context.bot.send_message(
        chat_id=user_id,
        text=f"–í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: {ref_code}\n\n–ü—Ä–æ—Å—Ç–æ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º –∫–æ–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏.",
        reply_markup=InlineKeyboardMarkup([[
            InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="invite_friend")
        ]])
    )

def show_referral_stats(update: Update, context: CallbackContext):
    """–ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ invite_friend"""
    query = update.callback_query
    query.answer()
    
    # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
    invite_friend(update, context)

def handle_show_subscription_options(update: Update, context: CallbackContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–í–∞—Ä–∏–∞–Ω—Ç—ã WILLWAY –ø–æ–¥–ø–∏—Å–∫–∏:"
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–º–Ω–µ–Ω–∏–π
    """
    query = update.callback_query
    query.answer()
    
    user_id = update.effective_user.id
    logger.info(f"[CALLBACK] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É '–í–∞—Ä–∏–∞–Ω—Ç—ã WILLWAY –ø–æ–¥–ø–∏—Å–∫–∏:'")
    
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –º–æ–¥—É–ª—è subscription_doubt_handler
    # –ò–º–ø–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
    from bot.subscription_doubt_handler import get_subscription_keyboard
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤—ã–±—Ä–∞—Ç—å "–ü–æ–¥—É–º–∞—é"
    # –ü–µ—Ä–µ–¥–∞–µ–º user_id –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ —Å Telegram ID
    query.edit_message_text(
        text="–í–∞—Ä–∏–∞–Ω—Ç—ã WILLWAY –ø–æ–¥–ø–∏—Å–∫–∏:",
        reply_markup=get_subscription_keyboard(user_id)
    )

def forward_to_health_assistant(update: Update, context: CallbackContext):
    """
    –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç
    """
    logger.info(f"–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç")
    handle_health_assistant_message(update, context)
    return

def get_health_assistant_response(user_id, user_message, conversation_history):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    
    –í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞.
    """
    logger.info(f"–ó–∞–ø—Ä–æ—Å –∫ Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {user_message}")
    
    try:
        # –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç GPT –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –º–æ–¥—É–ª—è gpt_assistant
        from bot.gpt_assistant import get_health_assistant_response as get_ai_response
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç GPT
        response = get_ai_response(user_id, user_message, conversation_history)
        
        # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
        if response:
            return response
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API GPT: {e}")
    
    # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∏–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
    return "–ò–∑–≤–∏–Ω–∏—Ç–µ, Health –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑-–∑–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."