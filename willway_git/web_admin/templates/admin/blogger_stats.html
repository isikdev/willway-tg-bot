{% extends 'admin/base.html' %}

{% block title %}WillWay Админ-панель - Статистика блогера{% endblock %}

{% block page_title %}Статистика блогера: {{ blogger.name }}{% endblock %}

{% block content %}
<div class="mt-8">
    <div
        class="pb-5 border-b border-gray-200 sm:flex sm:items-center sm:justify-between">
        <div class="flex-1 min-w-0">
            <h2
                class="text-lg font-medium leading-7 text-gray-900 sm:truncate sm:text-xl sm:tracking-tight">
                {{ blogger.name }}
            </h2>
            <div
                class="mt-1 flex flex-col sm:mt-0 sm:flex-row sm:flex-wrap sm:space-x-6">
                <div class="mt-2 flex items-center text-sm text-gray-500">
                    <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400"
                        viewBox="0 0 20 20" fill="currentColor"
                        aria-hidden="true">
                        <path
                            d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 00-13.074.003z" />
                    </svg>
                    ID: {{ blogger.id }}
                </div>
                <div class="mt-2 flex items-center text-sm text-gray-500">
                    <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400"
                        viewBox="0 0 20 20" fill="currentColor"
                        aria-hidden="true">
                        <path fill-rule="evenodd"
                            d="M5.5 9.5A3.5 3.5 0 019 6a3.5 3.5 0 15.5 9.5h-3A2 2 0 115.5 9.5m6.44-6.44l-2.5 2.5m0 0l-2.5 2.5m2.5-2.5l2.5 2.5m0 0l2.5 2.5"
                            clip-rule="evenodd" />
                    </svg>
                    {{ blogger.email or 'Нет email' }}
                </div>
                <div class="mt-2 flex items-center text-sm text-gray-500">
                    <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400"
                        viewBox="0 0 20 20" fill="currentColor"
                        aria-hidden="true">
                        <path
                            d="M3.5 2.75a.75.75 0 00-1.5 0v14.5a.75.75 0 001.5 0v-4.392l1.657-.348a6.449 6.449 0 014.271.572 7.948 7.948 0 005.965.524l2.078-.64A.75.75 0 0018 12.25v-8.5a.75.75 0 00-.904-.734l-2.38.501a7.25 7.25 0 01-4.186-.363l-.502-.2a8.75 8.75 0 00-5.053-.439l-1.475.31V2.75z" />
                    </svg>
                    Ключ: {{ blogger.access_key }}
                </div>
                <div class="mt-2 flex items-center text-sm text-gray-500">
                    <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400"
                        viewBox="0 0 20 20" fill="currentColor"
                        aria-hidden="true">
                        <path fill-rule="evenodd"
                            d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25v-6.5c0-.69-.56-1.25-1.25-1.25H4.75z"
                            clip-rule="evenodd" />
                    </svg>
                    Дата регистрации: {{ blogger.join_date.strftime('%d.%m.%Y')
                    }}
                </div>
            </div>
        </div>
        <div class="mt-3 flex sm:mt-0 sm:ml-4">
            <a href="{{ url_for('bloggers') }}"
                class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20"
                    fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z"
                        clip-rule="evenodd" />
                </svg>
                Назад к списку
            </a>
        </div>
    </div>

    <!-- Карточки с основной статистикой -->
    <div class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-3">
        <div class="overflow-hidden rounded-lg bg-white shadow">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-gray-400" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25V4.5m5.834.166l-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243l-1.59-1.59" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt
                                class="text-sm font-medium text-gray-500 truncate">Переходы
                                по ссылке</dt>
                            <dd class="text-lg font-medium text-gray-900">{{
                                blogger.total_referrals }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="overflow-hidden rounded-lg bg-white shadow">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-gray-400" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt
                                class="text-sm font-medium text-gray-500 truncate">Успешные
                                конверсии</dt>
                            <dd class="text-lg font-medium text-gray-900">{{
                                blogger.total_conversions }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="overflow-hidden rounded-lg bg-white shadow">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-gray-400" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt
                                class="text-sm font-medium text-gray-500 truncate">Всего
                                заработано</dt>
                            <dd class="text-lg font-medium text-gray-900">{{
                                blogger.total_earned|round(2) }} ₽</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблица с последними рефералами -->
    <div class="mt-8">
        <h3 class="text-lg font-medium leading-6 text-gray-900">История
            рефералов</h3>
        <div
            class="mt-4 overflow-hidden rounded-lg border border-gray-200 bg-white shadow">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ID
                            </th>
                            <th scope="col"
                                class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Дата
                            </th>
                            <th scope="col"
                                class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ID пользователя
                            </th>
                            <th scope="col"
                                class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Статус
                            </th>
                            <th scope="col"
                                class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Сумма
                            </th>
                            <th scope="col"
                                class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Комиссия
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% if referrals %}
                        {% for referral in referrals %}
                        <tr>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ referral.id }}
                            </td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{
                                referral.referral_date.strftime('%d.%m.%Y %H:%M')
                                }}
                            </td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ referral.user_id }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                {% if referral.converted %}
                                <span
                                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                    Конверсия
                                </span>
                                {% if referral.conversion_date %}
                                <span class="text-xs text-gray-500">
                                    {{
                                    referral.conversion_date.strftime('%d.%m.%Y')
                                    }}
                                </span>
                                {% endif %}
                                {% else %}
                                <span
                                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                    Только переход
                                </span>
                                {% endif %}
                            </td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {% if referral.subscription_amount %}
                                {{ referral.subscription_amount|round(2) }} ₽
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm font-medium text-primary">
                                {% if referral.commission_earned %}
                                {{ referral.commission_earned|round(2) }} ₽
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6"
                                class="px-6 py-4 text-center text-sm text-gray-500">
                                У блогера пока нет рефералов
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Информация о реферальной ссылке -->
    <div class="mt-8 bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Реферальная
            ссылка</h3>
        <div class="flex items-center">
            <div class="rounded-md shadow-sm flex-grow">
                <input id="referral-link" type="text" readonly
                    class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 px-3 placeholder:text-gray-400 focus:ring-primary sm:text-sm"
                    value="https://t.me/your_main_bot?start=ref_{{ blogger.access_key }}">
            </div>
            <button type="button" onclick="copyToClipboard()"
                class="ml-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                Копировать
            </button>
        </div>
        <div id="copy-message" class="mt-2 text-sm text-green-600 hidden">
            Ссылка скопирована в буфер обмена!
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function copyToClipboard() {
        var copyText = document.getElementById("referral-link");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
        
        var copyMessage = document.getElementById("copy-message");
        copyMessage.classList.remove("hidden");
        
        setTimeout(function() {
            copyMessage.classList.add("hidden");
        }, 3000);
    }
</script>
{% endblock %}